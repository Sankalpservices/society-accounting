<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Society Accounting Software - Sankalp Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            overflow-x: hidden;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 260px;
            height: 100vh;
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            color: white;
            transition: all 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        .sidebar.collapsed {
            width: 70px;
        }

        .sidebar-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-header h2 {
            font-size: 1.3em;
            margin-bottom: 5px;
        }

        .sidebar.collapsed .sidebar-header h2,
        .sidebar.collapsed .sidebar-header p,
        .sidebar.collapsed .menu-item span {
            display: none;
        }

        .society-selector {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .society-selector select {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background: rgba(255,255,255,0.1);
            color: white;
            cursor: pointer;
        }

        .society-selector select option {
            background: #2c3e50;
            color: white;
        }

        .sidebar.collapsed .society-selector {
            padding: 10px;
        }

        .sidebar.collapsed .society-selector select {
            display: none;
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .menu-item {
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
            color: rgba(255,255,255,0.8);
        }

        .menu-item:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .menu-item.active {
            background: rgba(102, 126, 234, 0.3);
            border-left: 4px solid #667eea;
            color: white;
        }

        .menu-item i {
            font-size: 20px;
            min-width: 20px;
        }

        .toggle-btn {
            position: absolute;
            top: 20px;
            right: -15px;
            width: 30px;
            height: 30px;
            background: #667eea;
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }

        .main-content {
            margin-left: 260px;
            padding: 30px;
            transition: margin-left 0.3s ease;
            min-height: 100vh;
        }

        .main-content.expanded {
            margin-left: 70px;
        }

        .top-bar {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .top-bar h1 {
            color: #2c3e50;
            font-size: 1.8em;
        }

        .content-area {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 500px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 14px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 12px;
        }

        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .stat-card p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .data-table th {
            background: #f8f9fa;
            color: #2c3e50;
            font-weight: 600;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            margin: 20px;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            line-height: 1;
        }

        .modal-close:hover {
            color: #f5576c;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .entry-row {
            display: grid;
            grid-template-columns: 2fr 3fr 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }

        .billing-head-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }

        @media print {
            .sidebar, .top-bar, .btn {
                display: none !important;
            }
            .main-content {
                margin-left: 0;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <button class="toggle-btn" onclick="toggleSidebar()">‚ò∞</button>
        
        <div class="sidebar-header">
            <h2>üè¢ Sankalp</h2>
            <p>Society Accounting</p>
        </div>

        <div class="society-selector">
            <select id="sidebarSocietySelect" onchange="changeSociety()">
                <option value="">Select Society</option>
            </select>
        </div>

        <div class="sidebar-menu">
            <div class="menu-item active" data-page="dashboard">
                <i>üìä</i>
                <span>Dashboard</span>
            </div>
            <div class="menu-item" data-page="societies">
                <i>üèòÔ∏è</i>
                <span>Societies</span>
            </div>
            <div class="menu-item" data-page="members">
                <i>üë•</i>
                <span>Members</span>
            </div>
            <div class="menu-item" data-page="accounts">
                <i>üìñ</i>
                <span>Chart of Accounts</span>
            </div>
            <div class="menu-item" data-page="billing">
                <i>üí∞</i>
                <span>Billing</span>
            </div>
            <div class="menu-item" data-page="entries">
                <i>üìù</i>
                <span>Entries</span>
            </div>
            <div class="menu-item" data-page="bankreconciliation">
                <i>üè¶</i>
                <span>Bank Reconciliation</span>
            </div>
            <div class="menu-item" data-page="reports">
                <i>üìà</i>
                <span>Reports</span>
            </div>
            <div class="menu-item" data-page="backup">
                <i>üíæ</i>
                <span>Backup & Export</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <div class="top-bar">
            <h1 id="pageTitle">Dashboard</h1>
            <div>
                <span id="currentSocietyName" style="color: #667eea; font-weight: 600;"></span>
            </div>
        </div>

        <div id="alertBox" class="alert"></div>

        <div class="content-area" id="contentArea">
            <!-- Content loaded dynamically -->
        </div>
    </div>

    <!-- All Modals from previous version -->
    <!-- Society Modal -->
    <div id="societyModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('societyModal')">&times;</span>
            <h2 id="societyModalTitle">Add New Society</h2>
            <form id="societyForm" onsubmit="saveSociety(event)">
                <input type="hidden" id="societyId">
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Society Name *</label>
                        <input type="text" id="societyName" required>
                    </div>

                    <div class="form-group">
                        <label>Registration Number *</label>
                        <input type="text" id="regNumber" required>
                    </div>

                    <div class="form-group">
                        <label>Address</label>
                        <textarea id="address" rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label>City</label>
                        <input type="text" id="city">
                    </div>

                    <div class="form-group">
                        <label>State</label>
                        <input type="text" id="state" value="Maharashtra">
                    </div>

                    <div class="form-group">
                        <label>PIN Code</label>
                        <input type="text" id="pincode" pattern="[0-9]{6}">
                    </div>

                    <div class="form-group">
                        <label>Contact Person</label>
                        <input type="text" id="contactPerson">
                    </div>

                    <div class="form-group">
                        <label>Mobile Number</label>
                        <input type="tel" id="mobile" pattern="[0-9]{10}">
                    </div>

                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="email">
                    </div>

                    <div class="form-group">
                        <label>Financial Year Start</label>
                        <select id="fyStart">
                            <option value="04">April</option>
                            <option value="01">January</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Status</label>
                        <select id="status">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success">Save Society</button>
                    <button type="button" class="btn" onclick="closeModal('societyModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Member Modal -->
    <div id="memberModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('memberModal')">&times;</span>
            <h2 id="memberModalTitle">Add Member</h2>
            <form id="memberForm" onsubmit="saveMember(event)">
                <input type="hidden" id="memberId">
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Member Name *</label>
                        <input type="text" id="memberName" required>
                    </div>

                    <div class="form-group">
                        <label>Flat/Unit No *</label>
                        <input type="text" id="flatNo" required>
                    </div>

                    <div class="form-group">
                        <label>Mobile Number *</label>
                        <input type="tel" id="memberMobile" pattern="[0-9]{10}" required>
                    </div>

                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="memberEmail">
                    </div>

                    <div class="form-group">
                        <label>Area (Sq. Ft.)</label>
                        <input type="number" id="area">
                    </div>

                    <div class="form-group">
                        <label>Share Amount</label>
                        <input type="number" id="shareAmount" step="0.01">
                    </div>

                    <div class="form-group">
                        <label>Opening Balance</label>
                        <input type="number" id="openingBalance" step="0.01" value="0">
                    </div>

                    <div class="form-group">
                        <label>Status</label>
                        <select id="memberStatus">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success">Save Member</button>
                    <button type="button" class="btn" onclick="closeModal('memberModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Account Modal -->
    <div id="accountModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('accountModal')">&times;</span>
            <h2 id="accountModalTitle">Add Account</h2>
            <form id="accountForm" onsubmit="saveAccount(event)">
                <input type="hidden" id="accountId">
                
                <div class="form-group">
                    <label>Account Group *</label>
                    <select id="accountGroup" required>
                        <option value="">Select Group</option>
                        <option value="Assets">Assets</option>
                        <option value="Liabilities">Liabilities</option>
                        <option value="Income">Income</option>
                        <option value="Expenses">Expenses</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Sub Group</label>
                    <input type="text" id="subGroup" placeholder="e.g., Current Assets, Fixed Assets">
                </div>

                <div class="form-group">
                    <label>Account Name *</label>
                    <input type="text" id="accountName" required placeholder="e.g., Cash, Bank, Members">
                </div>

                <div class="form-group">
                    <label>Account Code</label>
                    <input type="text" id="accountCode" placeholder="e.g., 1000, 2000">
                </div>

                <div class="form-group">
                    <label>Opening Balance</label>
                    <input type="number" id="accountOpeningBalance" step="0.01" value="0">
                </div>

                <div class="form-group">
                    <label>Balance Type</label>
                    <select id="balanceType">
                        <option value="debit">Debit</option>
                        <option value="credit">Credit</option>
                    </select>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success">Save Account</button>
                    <button type="button" class="btn" onclick="closeModal('accountModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Database Configuration
        const DB_NAME = 'SocietyAccountingDB';
        const DB_VERSION = 4;
        let db;
        let currentSocietyId = null;

        // Initialize Database
        function initDB() {
            const request = indexedDB.open(DB_NAME, DB_VERSION);

            request.onerror = (event) => {
                console.error('Database error:', event.target.error);
                showAlert('Database error: ' + event.target.error, 'error');
            };

            request.onsuccess = (event) => {
                db = event.target.result;
                console.log('Database initialized successfully');
                loadSocietiesIntoDropdown();
                checkSelectedSociety();
                setupMenuListeners();
            };

            request.onupgradeneeded = (event) => {
                db = event.target.result;
                
                // Societies Store
                if (!db.objectStoreNames.contains('societies')) {
                    const societyStore = db.createObjectStore('societies', { 
                        keyPath: 'id', 
                        autoIncrement: true 
                    });
                    societyStore.createIndex('name', 'name', { unique: false });
                    societyStore.createIndex('regNumber', 'regNumber', { unique: true });
                }

                // Members Store
                if (!db.objectStoreNames.contains('members')) {
                    const memberStore = db.createObjectStore('members', { 
                        keyPath: 'id', 
                        autoIncrement: true 
                    });
                    memberStore.createIndex('societyId', 'societyId', { unique: false });
                    memberStore.createIndex('flatNo', 'flatNo', { unique: false });
                }

                // Accounts Store
                if (!db.objectStoreNames.contains('accounts')) {
                    const accountStore = db.createObjectStore('accounts', { 
                        keyPath: 'id', 
                        autoIncrement: true 
                    });
                    accountStore.createIndex('societyId', 'societyId', { unique: false });
                    accountStore.createIndex('group', 'group', { unique: false });
                }

                // Bills Store
                if (!db.objectStoreNames.contains('bills')) {
                    const billStore = db.createObjectStore('bills', { 
                        keyPath: 'id', 
                        autoIncrement: true 
                    });
                    billStore.createIndex('societyId', 'societyId', { unique: false });
                    billStore.createIndex('memberId', 'memberId', { unique: false });
                }

                // Entries Store
                if (!db.objectStoreNames.contains('entries')) {
                    const entryStore = db.createObjectStore('entries', { 
                        keyPath: 'id', 
                        autoIncrement: true 
                    });
                    entryStore.createIndex('societyId', 'societyId', { unique: false });
                    entryStore.createIndex('entryType', 'entryType', { unique: false });
                }

                // Journal Lines Store
                if (!db.objectStoreNames.contains('journalLines')) {
                    const lineStore = db.createObjectStore('journalLines', { 
                        keyPath: 'id', 
                        autoIncrement: true 
                    });
                    lineStore.createIndex('entryId', 'entryId', { unique: false });
                    lineStore.createIndex('accountId', 'accountId', { unique: false });
                }

                // Bank Reconciliation Store
                if (!db.objectStoreNames.contains('bankReconciliations')) {
                    const reconStore = db.createObjectStore('bankReconciliations', { 
                        keyPath: 'id', 
                        autoIncrement: true 
                    });
                    reconStore.createIndex('societyId', 'societyId', { unique: false });
                    reconStore.createIndex('accountId', 'accountId', { unique: false });
                }

                console.log('Database upgrade completed');
            };
        }

        // Setup Menu Listeners - FIXED
        function setupMenuListeners() {
            const menuItems = document.querySelectorAll('.menu-item');
            menuItems.forEach(item => {
                item.addEventListener('click', function() {
                    const page = this.getAttribute('data-page');
                    navigateTo(page);
                });
            });
        }

        // Navigation Function - COMPLETELY FIXED
        function navigateTo(page) {
            console.log('Navigating to:', page);
            
            // Remove active class from all menu items
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to clicked item
            const activeItem = document.querySelector(`.menu-item[data-page="${page}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }

            // Update page title
            const titles = {
                'dashboard': 'Dashboard',
                'societies': 'Manage Societies',
                'members': 'Member Management',
                'accounts': 'Chart of Accounts',
                'billing': 'Billing & Invoicing',
                'entries': 'Accounting Entries',
                'bankreconciliation': 'Bank Reconciliation',
                'reports': 'Financial Reports',
                'backup': 'Backup & Export'
            };
            document.getElementById('pageTitle').textContent = titles[page] || page;

            // Load page content
            loadPageContent(page);
        }

        // Load Page Content
        function loadPageContent(page) {
            console.log('Loading content for:', page);
            
            switch(page) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'societies':
                    loadSocietiesPage();
                    break;
                case 'members':
                    loadMembersPage();
                    break;
                case 'accounts':
                    loadAccountsPage();
                    break;
                case 'billing':
                    loadBillingPage();
                    break;
                case 'entries':
                    loadEntriesPage();
                    break;
                case 'bankreconciliation':
                    loadBankReconciliationPage();
                    break;
                case 'reports':
                    loadReportsPage();
                    break;
                case 'backup':
                    loadBackupPage();
                    break;
                default:
                    loadDashboard();
            }
        }

        // Load Dashboard - FIXED
        function loadDashboard() {
            if (!currentSocietyId) {
                document.getElementById('contentArea').innerHTML = `
                    <div style="text-align: center; padding: 60px;">
                        <h2 style="color: #999;">No Society Selected</h2>
                        <p>Please select a society from the dropdown above or create a new one.</p>
                        <button class="btn btn-success" onclick="navigateTo('societies')">Manage Societies</button>
                    </div>
                `;
                return;
            }

            const transaction = db.transaction(['members', 'accounts', 'entries'], 'readonly');
            const memberStore = transaction.objectStore('members');
            const accountStore = transaction.objectStore('accounts');
            const entryStore = transaction.objectStore('entries');

            const memberIndex = memberStore.index('societyId');
            const accountIndex = accountStore.index('societyId');
            const entryIndex = entryStore.index('societyId');

            const memberRequest = memberIndex.getAll(currentSocietyId);
            const accountRequest = accountIndex.getAll(currentSocietyId);
            const entryRequest = entryIndex.getAll(currentSocietyId);

            Promise.all([
                new Promise(resolve => { memberRequest.onsuccess = () => resolve(memberRequest.result); }),
                new Promise(resolve => { accountRequest.onsuccess = () => resolve(accountRequest.result); }),
                new Promise(resolve => { entryRequest.onsuccess = () => resolve(entryRequest.result); })
            ]).then(([members, accounts, entries]) => {
                const activeMembers = members.filter(m => m.status === 'active').length;
                
                document.getElementById('contentArea').innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>${members.length}</h3>
                            <p>Total Members</p>
                        </div>
                        <div class="stat-card">
                            <h3>${activeMembers}</h3>
                            <p>Active Members</p>
                        </div>
                        <div class="stat-card">
                            <h3>${accounts.length}</h3>
                            <p>Chart of Accounts</p>
                        </div>
                        <div class="stat-card">
                            <h3>${entries.length}</h3>
                            <p>Total Entries</p>
                        </div>
                    </div>

                    <h3 style="margin-top: 30px; margin-bottom: 20px;">Quick Actions</h3>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="navigateTo('members')">Add Member</button>
                        <button class="btn btn-success" onclick="navigateTo('accounts')">Setup Accounts</button>
                        <button class="btn" onclick="navigateTo('billing')">Generate Bills</button>
                        <button class="btn" onclick="navigateTo('entries')">New Entry</button>
                        <button class="btn" onclick="navigateTo('reports')">View Reports</button>
                    </div>

                    <h3 style="margin-top: 40px; margin-bottom: 20px;">Recent Entries</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Entry Type</th>
                                <th>Reference</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${entries.slice(-5).reverse().map(e => `
                                <tr>
                                    <td>${new Date(e.date).toLocaleDateString()}</td>
                                    <td><strong>${e.entryType.toUpperCase()}</strong></td>
                                    <td>${e.refNumber || 'N/A'}</td>
                                    <td>‚Çπ${e.amount.toFixed(2)}</td>
                                </tr>
                            `).join('') || '<tr><td colspan="4" style="text-align: center; color: #999;">No entries yet</td></tr>'}
                        </tbody>
                    </table>
                `;
            });
        }

        // Load Societies Page - FIXED
        function loadSocietiesPage() {
            console.log('Loading societies page...');
            
            if (!db) {
                showAlert('Database not initialized', 'error');
                return;
            }

            const transaction = db.transaction(['societies'], 'readonly');
            const objectStore = transaction.objectStore('societies');
            const request = objectStore.getAll();

            request.onsuccess = () => {
                const societies = request.result;
                console.log('Societies loaded:', societies.length);
                const activeSocieties = societies.filter(s => s.status === 'active').length;

                document.getElementById('contentArea').innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>${societies.length}</h3>
                            <p>Total Societies</p>
                        </div>
                        <div class="stat-card">
                            <h3>${activeSocieties}</h3>
                            <p>Active Societies</p>
                        </div>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>All Societies</h3>
                        <button class="btn btn-success" onclick="openAddSocietyModal()">+ Add New Society</button>
                    </div>

                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Society Name</th>
                                <th>Reg Number</th>
                                <th>City</th>
                                <th>Contact</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${societies.map(s => `
                                <tr>
                                    <td><strong>${s.name}</strong></td>
                                    <td>${s.regNumber}</td>
                                    <td>${s.city || 'N/A'}</td>
                                    <td>${s.mobile || 'N/A'}</td>
                                    <td><span style="color: ${s.status === 'active' ? 'green' : 'red'};">${s.status.toUpperCase()}</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-success" onclick="selectSocietyDirect(${s.id})">Select</button>
                                        <button class="btn btn-sm" onclick="editSociety(${s.id})">Edit</button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteSociety(${s.id})">Delete</button>
                                    </td>
                                </tr>
                            `).join('') || '<tr><td colspan="6" style="text-align: center; color: #999;">No societies found</td></tr>'}
                        </tbody>
                    </table>
                `;
            };

            request.onerror = () => {
                showAlert('Error loading societies', 'error');
            };
        }

        // Society Functions
        function openAddSocietyModal() {
            console.log('Opening add society modal');
            document.getElementById('societyModalTitle').textContent = 'Add New Society';
            document.getElementById('societyForm').reset();
            document.getElementById('societyId').value = '';
            document.getElementById('societyModal').classList.add('active');
        }

        function saveSociety(event) {
            event.preventDefault();
            
            const society = {
                name: document.getElementById('societyName').value,
                regNumber: document.getElementById('regNumber').value,
                address: document.getElementById('address').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value,
                pincode: document.getElementById('pincode').value,
                contactPerson: document.getElementById('contactPerson').value,
                mobile: document.getElementById('mobile').value,
                email: document.getElementById('email').value,
                fyStart: document.getElementById('fyStart').value,
                status: document.getElementById('status').value,
                createdDate: new Date().toISOString(),
                modifiedDate: new Date().toISOString()
            };

            const societyId = document.getElementById('societyId').value;
            if (societyId) {
                society.id = parseInt(societyId);
            }

            const transaction = db.transaction(['societies'], 'readwrite');
            const objectStore = transaction.objectStore('societies');
            
            const request = societyId ? objectStore.put(society) : objectStore.add(society);

            request.onsuccess = () => {
                showAlert(societyId ? 'Society updated successfully!' : 'Society added successfully!', 'success');
                closeModal('societyModal');
                loadSocietiesIntoDropdown();
                loadSocietiesPage();
            };

            request.onerror = (event) => {
                showAlert('Error saving society: ' + event.target.error, 'error');
            };
        }

        function editSociety(id) {
            const transaction = db.transaction(['societies'], 'readonly');
            const objectStore = transaction.objectStore('societies');
            const request = objectStore.get(id);

            request.onsuccess = () => {
                const society = request.result;
                
                document.getElementById('societyModalTitle').textContent = 'Edit Society';
                document.getElementById('societyId').value = society.id;
                document.getElementById('societyName').value = society.name;
                document.getElementById('regNumber').value = society.regNumber;
                document.getElementById('address').value = society.address || '';
                document.getElementById('city').value = society.city || '';
                document.getElementById('state').value = society.state || '';
                document.getElementById('pincode').value = society.pincode || '';
                document.getElementById('contactPerson').value = society.contactPerson || '';
                document.getElementById('mobile').value = society.mobile || '';
                document.getElementById('email').value = society.email || '';
                document.getElementById('fyStart').value = society.fyStart;
                document.getElementById('status').value = society.status;
                
                document.getElementById('societyModal').classList.add('active');
            };
        }

        function deleteSociety(id) {
            if (!confirm('Are you sure you want to delete this society? All related data will be lost!')) return;

            const transaction = db.transaction(['societies'], 'readwrite');
            const objectStore = transaction.objectStore('societies');
            const request = objectStore.delete(id);

            request.onsuccess = () => {
                showAlert('Society deleted successfully!', 'success');
                loadSocietiesIntoDropdown();
                loadSocietiesPage();
                
                if (currentSocietyId === id) {
                    currentSocietyId = null;
                    localStorage.removeItem('selectedSocietyId');
                    document.getElementById('currentSocietyName').textContent = '';
                }
            };
        }

        // Load Members Page - FIXED
        function loadMembersPage() {
            if (!currentSocietyId) {
                document.getElementById('contentArea').innerHTML = '<p style="padding: 40px; text-align: center; color: #999;">Please select a society first</p>';
                return;
            }

            const transaction = db.transaction(['members'], 'readonly');
            const memberStore = transaction.objectStore('members');
            const index = memberStore.index('societyId');
            const request = index.getAll(currentSocietyId);

            request.onsuccess = () => {
                const members = request.result;
                const activeMembers = members.filter(m => m.status === 'active').length;

                document.getElementById('contentArea').innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>${members.length}</h3>
                            <p>Total Members</p>
                        </div>
                        <div class="stat-card">
                            <h3>${activeMembers}</h3>
                            <p>Active Members</p>
                        </div>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>All Members</h3>
                        <button class="btn btn-success" onclick="openAddMemberModal()">+ Add New Member</button>
                    </div>

                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Flat No</th>
                                <th>Member Name</th>
                                <th>Mobile</th>
                                <th>Email</th>
                                <th>Area (Sq.Ft.)</th>
                                <th>Share Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${members.map(m => `
                                <tr>
                                    <td><strong>${m.flatNo}</strong></td>
                                    <td>${m.name}</td>
                                    <td>${m.mobile}</td>
                                    <td>${m.email || 'N/A'}</td>
                                    <td>${m.area || 'N/A'}</td>
                                    <td>‚Çπ${m.shareAmount || 0}</td>
                                    <td><span style="color: ${m.status === 'active' ? 'green' : 'red'};">${m.status.toUpperCase()}</span></td>
                                    <td>
                                        <button class="btn btn-sm" onclick="editMember(${m.id})">Edit</button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteMember(${m.id})">Delete</button>
                                    </td>
                                </tr>
                            `).join('') || '<tr><td colspan="8" style="text-align: center; color: #999;">No members found. Add your first member!</td></tr>'}
                        </tbody>
                    </table>
                `;
            };
        }

        // Member Functions
        function openAddMemberModal() {
            document.getElementById('memberModalTitle').textContent = 'Add New Member';
            document.getElementById('memberForm').reset();
            document.getElementById('memberId').value = '';
            document.getElementById('memberModal').classList.add('active');
        }

        function saveMember(event) {
            event.preventDefault();
            
            const member = {
                societyId: currentSocietyId,
                name: document.getElementById('memberName').value,
                flatNo: document.getElementById('flatNo').value,
                mobile: document.getElementById('memberMobile').value,
                email: document.getElementById('memberEmail').value,
                area: document.getElementById('area').value,
                shareAmount: document.getElementById('shareAmount').value,
                openingBalance: document.getElementById('openingBalance').value,
                status: document.getElementById('memberStatus').value,
                createdDate: new Date().toISOString()
            };

            const memberId = document.getElementById('memberId').value;
            if (memberId) {
                member.id = parseInt(memberId);
            }

            const transaction = db.transaction(['members'], 'readwrite');
            const objectStore = transaction.objectStore('members');
            const request = memberId ? objectStore.put(member) : objectStore.add(member);

            request.onsuccess = () => {
                showAlert(memberId ? 'Member updated successfully!' : 'Member added successfully!', 'success');
                closeModal('memberModal');
                loadMembersPage();
            };

            request.onerror = (event) => {
                showAlert('Error saving member: ' + event.target.error, 'error');
            };
        }

        function editMember(id) {
            const transaction = db.transaction(['members'], 'readonly');
            const objectStore = transaction.objectStore('members');
            const request = objectStore.get(id);

            request.onsuccess = () => {
                const member = request.result;
                
                document.getElementById('memberModalTitle').textContent = 'Edit Member';
                document.getElementById('memberId').value = member.id;
                document.getElementById('memberName').value = member.name;
                document.getElementById('flatNo').value = member.flatNo;
                document.getElementById('memberMobile').value = member.mobile;
                document.getElementById('memberEmail').value = member.email || '';
                document.getElementById('area').value = member.area || '';
                document.getElementById('shareAmount').value = member.shareAmount || '';
                document.getElementById('openingBalance').value = member.openingBalance || 0;
                document.getElementById('memberStatus').value = member.status;
                
                document.getElementById('memberModal').classList.add('active');
            };
        }

        function deleteMember(id) {
            if (!confirm('Are you sure you want to delete this member?')) return;

            const transaction = db.transaction(['members'], 'readwrite');
            const objectStore = transaction.objectStore('members');
            const request = objectStore.delete(id);

            request.onsuccess = () => {
                showAlert('Member deleted successfully!', 'success');
                loadMembersPage();
            };
        }

        // Load Chart of Accounts Page - FIXED
        function loadAccountsPage() {
            if (!currentSocietyId) {
                document.getElementById('contentArea').innerHTML = '<p style="padding: 40px; text-align: center; color: #999;">Please select a society first</p>';
                return;
            }

            const transaction = db.transaction(['accounts'], 'readonly');
            const accountStore = transaction.objectStore('accounts');
            const index = accountStore.index('societyId');
            const request = index.getAll(currentSocietyId);

            request.onsuccess = () => {
                const accounts = request.result;
                
                // Group accounts by main group
                const groupedAccounts = accounts.reduce((acc, account) => {
                    if (!acc[account.group]) acc[account.group] = [];
                    acc[account.group].push(account);
                    return acc;
                }, {});

                let tableHTML = '';
                ['Assets', 'Liabilities', 'Income', 'Expenses'].forEach(group => {
                    const groupAccounts = groupedAccounts[group] || [];
                    tableHTML += `
                        <tr style="background: #667eea; color: white; font-weight: bold;">
                            <td colspan="6">${group} (${groupAccounts.length})</td>
                        </tr>
                        ${groupAccounts.map(a => `
                            <tr>
                                <td style="padding-left: 30px;">${a.code || '-'}</td>
                                <td>${a.name}</td>
                                <td>${a.subGroup || '-'}</td>
                                <td>‚Çπ${a.openingBalance || 0}</td>
                                <td>${a.balanceType}</td>
                                <td>
                                    <button class="btn btn-sm" onclick="editAccount(${a.id})">Edit</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteAccount(${a.id})">Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    `;
                });

                document.getElementById('contentArea').innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <h3>Chart of Accounts</h3>
                            <p style="color: #666; margin-top: 5px;">Define all ledger accounts for accounting entries</p>
                        </div>
                        <button class="btn btn-success" onclick="openAddAccountModal()">+ Add New Account</button>
                    </div>

                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Account Name</th>
                                <th>Sub Group</th>
                                <th>Opening Balance</th>
                                <th>Type</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableHTML || '<tr><td colspan="6" style="text-align: center; color: #999;">No accounts found. Add your first account!</td></tr>'}
                        </tbody>
                    </table>

                    <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                        <h4>Suggested Accounts for Housing Society</h4>
                        <p style="margin: 10px 0;">Click to add standard accounts:</p>
                        <button class="btn btn-sm btn-success" onclick="addStandardAccounts()">Add Standard Accounts</button>
                    </div>
                `;
            };
        }

        // Account Functions
        function openAddAccountModal() {
            document.getElementById('accountModalTitle').textContent = 'Add New Account';
            document.getElementById('accountForm').reset();
            document.getElementById('accountId').value = '';
            document.getElementById('accountModal').classList.add('active');
        }

        function saveAccount(event) {
            event.preventDefault();
            
            const account = {
                societyId: currentSocietyId,
                group: document.getElementById('accountGroup').value,
                subGroup: document.getElementById('subGroup').value,
                name: document.getElementById('accountName').value,
                code: document.getElementById('accountCode').value,
                openingBalance: document.getElementById('accountOpeningBalance').value,
                balanceType: document.getElementById('balanceType').value,
                createdDate: new Date().toISOString()
            };

            const accountId = document.getElementById('accountId').value;
            if (accountId) {
                account.id = parseInt(accountId);
            }

            const transaction = db.transaction(['accounts'], 'readwrite');
            const objectStore = transaction.objectStore('accounts');
            const request = accountId ? objectStore.put(account) : objectStore.add(account);

            request.onsuccess = () => {
                showAlert(accountId ? 'Account updated successfully!' : 'Account added successfully!', 'success');
                closeModal('accountModal');
                loadAccountsPage();
            };

            request.onerror = (event) => {
                showAlert('Error saving account: ' + event.target.error, 'error');
            };
        }

        function editAccount(id) {
            const transaction = db.transaction(['accounts'], 'readonly');
            const objectStore = transaction.objectStore('accounts');
            const request = objectStore.get(id);

            request.onsuccess = () => {
                const account = request.result;
                
                document.getElementById('accountModalTitle').textContent = 'Edit Account';
                document.getElementById('accountId').value = account.id;
                document.getElementById('accountGroup').value = account.group;
                document.getElementById('subGroup').value = account.subGroup || '';
                document.getElementById('accountName').value = account.name;
                document.getElementById('accountCode').value = account.code || '';
                document.getElementById('accountOpeningBalance').value = account.openingBalance || 0;
                document.getElementById('balanceType').value = account.balanceType;
                
                document.getElementById('accountModal').classList.add('active');
            };
        }

        function deleteAccount(id) {
            if (!confirm('Are you sure you want to delete this account?')) return;

            const transaction = db.transaction(['accounts'], 'readwrite');
            const objectStore = transaction.objectStore('accounts');
            const request = objectStore.delete(id);

            request.onsuccess = () => {
                showAlert('Account deleted successfully!', 'success');
                loadAccountsPage();
            };
        }

        function addStandardAccounts() {
            const standardAccounts = [
                { group: 'Assets', subGroup: 'Current Assets', name: 'Cash in Hand', code: '1001', balanceType: 'debit', openingBalance: 0 },
                { group: 'Assets', subGroup: 'Current Assets', name: 'Bank Account - SBI', code: '1002', balanceType: 'debit', openingBalance: 0 },
                { group: 'Assets', subGroup: 'Current Assets', name: 'Members Outstanding', code: '1010', balanceType: 'debit', openingBalance: 0 },
                { group: 'Assets', subGroup: 'Fixed Assets', name: 'Building', code: '1100', balanceType: 'debit', openingBalance: 0 },
                { group: 'Liabilities', subGroup: 'Current Liabilities', name: 'Sundry Creditors', code: '2001', balanceType: 'credit', openingBalance: 0 },
                { group: 'Liabilities', subGroup: 'Reserves', name: 'Corpus Fund', code: '2100', balanceType: 'credit', openingBalance: 0 },
                { group: 'Income', subGroup: 'Member Contributions', name: 'Maintenance Charges', code: '4001', balanceType: 'credit', openingBalance: 0 },
                { group: 'Income', subGroup: 'Member Contributions', name: 'Water Charges', code: '4002', balanceType: 'credit', openingBalance: 0 },
                { group: 'Income', subGroup: 'Other Income', name: 'Interest Income', code: '4100', balanceType: 'credit', openingBalance: 0 },
                { group: 'Expenses', subGroup: 'Operating Expenses', name: 'Electricity Charges', code: '5001', balanceType: 'debit', openingBalance: 0 },
                { group: 'Expenses', subGroup: 'Operating Expenses', name: 'Water Charges - Municipal', code: '5002', balanceType: 'debit', openingBalance: 0 },
                { group: 'Expenses', subGroup: 'Operating Expenses', name: 'Staff Salaries', code: '5010', balanceType: 'debit', openingBalance: 0 },
                { group: 'Expenses', subGroup: 'Operating Expenses', name: 'Repairs & Maintenance', code: '5020', balanceType: 'debit', openingBalance: 0 },
            ];

            const transaction = db.transaction(['accounts'], 'readwrite');
            const objectStore = transaction.objectStore('accounts');

            let addedCount = 0;
            standardAccounts.forEach(account => {
                account.societyId = currentSocietyId;
                account.createdDate = new Date().toISOString();
                
                const request = objectStore.add(account);
                request.onsuccess = () => {
                    addedCount++;
                    if (addedCount === standardAccounts.length) {
                        showAlert(`${addedCount} standard accounts added successfully!`, 'success');
                        loadAccountsPage();
                    }
                };
                request.onerror = () => {
                    addedCount++; // Skip duplicates
                    if (addedCount === standardAccounts.length) {
                        showAlert(`Standard accounts added (some may have been skipped if duplicates)`, 'success');
                        loadAccountsPage();
                    }
                };
            });
        }

        // Placeholder functions for other modules
        function loadBillingPage() {
            document.getElementById('contentArea').innerHTML = '<p style="padding: 40px; text-align: center; color: #999;">Billing module - Coming soon</p>';
        }

        function loadEntriesPage() {
            document.getElementById('contentArea').innerHTML = '<p style="padding: 40px; text-align: center; color: #999;">Entries module - Coming soon</p>';
        }

        function loadBankReconciliationPage() {
            document.getElementById('contentArea').innerHTML = '<p style="padding: 40px; text-align: center; color: #999;">Bank Reconciliation module - Coming soon</p>';
        }

        function loadReportsPage() {
            document.getElementById('contentArea').innerHTML = '<p style="padding: 40px; text-align: center; color: #999;">Reports module - Coming soon</p>';
        }

        function loadBackupPage() {
            document.getElementById('contentArea').innerHTML = '<p style="padding: 40px; text-align: center; color: #999;">Backup & Export module - Coming soon</p>';
        }

        // Society Management Functions
        function loadSocietiesIntoDropdown() {
            const transaction = db.transaction(['societies'], 'readonly');
            const objectStore = transaction.objectStore('societies');
            const request = objectStore.getAll();

            request.onsuccess = () => {
                const societies = request.result;
                const select = document.getElementById('sidebarSocietySelect');
                
                select.innerHTML = '<option value="">Select Society</option>';
                societies.forEach(society => {
                    const option = document.createElement('option');
                    option.value = society.id;
                    option.textContent = society.name;
                    select.appendChild(option);
                });

                if (currentSocietyId) {
                    select.value = currentSocietyId;
                }
            };
        }

        function changeSociety() {
            const select = document.getElementById('sidebarSocietySelect');
            currentSocietyId = select.value ? parseInt(select.value) : null;
            
            if (currentSocietyId) {
                localStorage.setItem('selectedSocietyId', currentSocietyId);
                
                const transaction = db.transaction(['societies'], 'readonly');
                const objectStore = transaction.objectStore('societies');
                const request = objectStore.get(currentSocietyId);
                
                request.onsuccess = () => {
                    const society = request.result;
                    document.getElementById('currentSocietyName').textContent = society.name;
                    showAlert(`Society changed to: ${society.name}`, 'success');
                    loadDashboard();
                };
            } else {
                localStorage.removeItem('selectedSocietyId');
                document.getElementById('currentSocietyName').textContent = '';
                loadDashboard();
            }
        }

        function selectSocietyDirect(id) {
            currentSocietyId = id;
            localStorage.setItem('selectedSocietyId', id);
            document.getElementById('sidebarSocietySelect').value = id;
            
            const transaction = db.transaction(['societies'], 'readonly');
            const objectStore = transaction.objectStore('societies');
            const request = objectStore.get(id);
            
            request.onsuccess = () => {
                const society = request.result;
                document.getElementById('currentSocietyName').textContent = society.name;
                showAlert(`Society selected: ${society.name}`, 'success');
                navigateTo('dashboard');
            };
        }

        function checkSelectedSociety() {
            const savedSocietyId = localStorage.getItem('selectedSocietyId');
            if (savedSocietyId) {
                currentSocietyId = parseInt(savedSocietyId);
                document.getElementById('sidebarSocietySelect').value = currentSocietyId;
                
                const transaction = db.transaction(['societies'], 'readonly');
                const objectStore = transaction.objectStore('societies');
                const request = objectStore.get(currentSocietyId);
                
                request.onsuccess = () => {
                    if (request.result) {
                        document.getElementById('currentSocietyName').textContent = request.result.name;
                    }
                };
            }
            loadDashboard();
        }

        // Utility Functions
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showAlert(message, type) {
            const alertBox = document.getElementById('alertBox');
            alertBox.className = `alert alert-${type} show`;
            alertBox.textContent = message;
            
            setTimeout(() => {
                alertBox.classList.remove('show');
            }, 5000);
        }

        // Initialize
        window.onload = () => {
            console.log('Initializing application...');
            initDB();
        };
    </script>
</body>
</html>
