<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Society Accounting Software - Sankalp Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            overflow-x: hidden;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 260px;
            height: 100vh;
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            color: white;
            transition: all 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        .sidebar.collapsed {
            width: 70px;
        }

        .sidebar-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-header h2 {
            font-size: 1.3em;
            margin-bottom: 5px;
        }

        .sidebar.collapsed .sidebar-header h2,
        .sidebar.collapsed .sidebar-header p,
        .sidebar.collapsed .menu-item span {
            display: none;
        }

        .society-selector {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .society-selector select {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background: rgba(255,255,255,0.1);
            color: white;
            cursor: pointer;
        }

        .society-selector select option {
            background: #2c3e50;
            color: white;
        }

        .sidebar.collapsed .society-selector {
            padding: 10px;
        }

        .sidebar.collapsed .society-selector select {
            display: none;
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .menu-item {
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
            color: rgba(255,255,255,0.8);
        }

        .menu-item:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .menu-item.active {
            background: rgba(102, 126, 234, 0.3);
            border-left: 4px solid #667eea;
            color: white;
        }

        .menu-item i {
            font-size: 20px;
            min-width: 20px;
        }

        .toggle-btn {
            position: absolute;
            top: 20px;
            right: -15px;
            width: 30px;
            height: 30px;
            background: #667eea;
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }

        .main-content {
            margin-left: 260px;
            padding: 30px;
            transition: margin-left 0.3s ease;
            min-height: 100vh;
        }

        .main-content.expanded {
            margin-left: 70px;
        }

        .top-bar {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .top-bar h1 {
            color: #2c3e50;
            font-size: 1.8em;
        }

        .content-area {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 500px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 14px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 12px;
        }

        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .stat-card p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .data-table th {
            background: #f8f9fa;
            color: #2c3e50;
            font-weight: 600;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            margin: 20px;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            line-height: 1;
        }

        .modal-close:hover {
            color: #f5576c;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .entry-row {
            display: grid;
            grid-template-columns: 2fr 3fr 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }

        .billing-head-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }

        .report-section {
            margin-bottom: 40px;
        }

        .report-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #667eea;
        }

        .report-header h2 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .reconciliation-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .reconciliation-panel {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
        }

        .reconciliation-panel h4 {
            margin-bottom: 15px;
            color: #667eea;
        }

        @media print {
            .sidebar, .top-bar, .btn, .print-btn {
                display: none !important;
            }
            .main-content {
                margin-left: 0;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <button class="toggle-btn" onclick="toggleSidebar()">‚ò∞</button>
        
        <div class="sidebar-header">
            <h2>üè¢ Sankalp</h2>
            <p>Society Accounting</p>
        </div>

        <div class="society-selector">
            <select id="sidebarSocietySelect" onchange="changeSociety()">
                <option value="">Select Society</option>
            </select>
        </div>

        <div class="sidebar-menu">
            <div class="menu-item active" onclick="navigateTo('dashboard')">
                <i>üìä</i>
                <span>Dashboard</span>
            </div>
            <div class="menu-item" onclick="navigateTo('societies')">
                <i>üèòÔ∏è</i>
                <span>Societies</span>
            </div>
            <div class="menu-item" onclick="navigateTo('members')">
                <i>üë•</i>
                <span>Members</span>
            </div>
            <div class="menu-item" onclick="navigateTo('accounts')">
                <i>üìñ</i>
                <span>Chart of Accounts</span>
            </div>
            <div class="menu-item" onclick="navigateTo('billing')">
                <i>üí∞</i>
                <span>Billing</span>
            </div>
            <div class="menu-item" onclick="navigateTo('entries')">
                <i>üìù</i>
                <span>Entries</span>
            </div>
            <div class="menu-item" onclick="navigateTo('bankreconciliation')">
                <i>üè¶</i>
                <span>Bank Reconciliation</span>
            </div>
            <div class="menu-item" onclick="navigateTo('reports')">
                <i>üìà</i>
                <span>Reports</span>
            </div>
            <div class="menu-item" onclick="navigateTo('backup')">
                <i>üíæ</i>
                <span>Backup & Export</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <div class="top-bar">
            <h1 id="pageTitle">Dashboard</h1>
            <div>
                <span id="currentSocietyName" style="color: #667eea; font-weight: 600;"></span>
            </div>
        </div>

        <div id="alertBox" class="alert"></div>

        <div class="content-area" id="contentArea">
            <!-- Content loaded dynamically -->
        </div>
    </div>

    <!-- Society Modal -->
    <div id="societyModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('societyModal')">&times;</span>
            <h2 id="societyModalTitle">Add New Society</h2>
            <form id="societyForm" onsubmit="saveSociety(event)">
                <input type="hidden" id="societyId">
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Society Name *</label>
                        <input type="text" id="societyName" required>
                    </div>

                    <div class="form-group">
                        <label>Registration Number *</label>
                        <input type="text" id="regNumber" required>
                    </div>

                    <div class="form-group">
                        <label>Address</label>
                        <textarea id="address" rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label>City</label>
                        <input type="text" id="city">
                    </div>

                    <div class="form-group">
                        <label>State</label>
                        <input type="text" id="state" value="Maharashtra">
                    </div>

                    <div class="form-group">
                        <label>PIN Code</label>
                        <input type="text" id="pincode" pattern="[0-9]{6}">
                    </div>

                    <div class="form-group">
                        <label>Contact Person</label>
                        <input type="text" id="contactPerson">
                    </div>

                    <div class="form-group">
                        <label>Mobile Number</label>
                        <input type="tel" id="mobile" pattern="[0-9]{10}">
                    </div>

                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="email">
                    </div>

                    <div class="form-group">
                        <label>Financial Year Start</label>
                        <select id="fyStart">
                            <option value="04">April</option>
                            <option value="01">January</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Status</label>
                        <select id="status">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success">Save Society</button>
                    <button type="button" class="btn" onclick="closeModal('societyModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Member Modal -->
    <div id="memberModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('memberModal')">&times;</span>
            <h2 id="memberModalTitle">Add Member</h2>
            <form id="memberForm" onsubmit="saveMember(event)">
                <input type="hidden" id="memberId">
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Member Name *</label>
                        <input type="text" id="memberName" required>
                    </div>

                    <div class="form-group">
                        <label>Flat/Unit No *</label>
                        <input type="text" id="flatNo" required>
                    </div>

                    <div class="form-group">
                        <label>Mobile Number *</label>
                        <input type="tel" id="memberMobile" pattern="[0-9]{10}" required>
                    </div>

                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="memberEmail">
                    </div>

                    <div class="form-group">
                        <label>Area (Sq. Ft.)</label>
                        <input type="number" id="area">
                    </div>

                    <div class="form-group">
                        <label>Share Amount</label>
                        <input type="number" id="shareAmount" step="0.01">
                    </div>

                    <div class="form-group">
                        <label>Opening Balance</label>
                        <input type="number" id="openingBalance" step="0.01" value="0">
                    </div>

                    <div class="form-group">
                        <label>Status</label>
                        <select id="memberStatus">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success">Save Member</button>
                    <button type="button" class="btn" onclick="closeModal('memberModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Account Modal -->
    <div id="accountModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('accountModal')">&times;</span>
            <h2 id="accountModalTitle">Add Account</h2>
            <form id="accountForm" onsubmit="saveAccount(event)">
                <input type="hidden" id="accountId">
                
                <div class="form-group">
                    <label>Account Group *</label>
                    <select id="accountGroup" required>
                        <option value="">Select Group</option>
                        <option value="Assets">Assets</option>
                        <option value="Liabilities">Liabilities</option>
                        <option value="Income">Income</option>
                        <option value="Expenses">Expenses</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Sub Group</label>
                    <input type="text" id="subGroup" placeholder="e.g., Current Assets, Fixed Assets">
                </div>

                <div class="form-group">
                    <label>Account Name *</label>
                    <input type="text" id="accountName" required placeholder="e.g., Cash, Bank, Members">
                </div>

                <div class="form-group">
                    <label>Account Code</label>
                    <input type="text" id="accountCode" placeholder="e.g., 1000, 2000">
                </div>

                <div class="form-group">
                    <label>Opening Balance</label>
                    <input type="number" id="accountOpeningBalance" step="0.01" value="0">
                </div>

                <div class="form-group">
                    <label>Balance Type</label>
                    <select id="balanceType">
                        <option value="debit">Debit</option>
                        <option value="credit">Credit</option>
                    </select>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success">Save Account</button>
                    <button type="button" class="btn" onclick="closeModal('accountModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Billing Modal -->
    <div id="billingModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('billingModal')">&times;</span>
            <h2>Generate Member Bills</h2>
            <form id="billingForm" onsubmit="generateBills(event)">
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Billing Frequency *</label>
                        <select id="billingFrequency" required onchange="updateBillingPeriod()">
                            <option value="monthly">Monthly</option>
                            <option value="bimonthly">Bi-Monthly (Every 2 Months)</option>
                            <option value="quarterly">Quarterly</option>
                            <option value="halfyearly">Half-Yearly</option>
                            <option value="yearly">Yearly</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Billing Period From *</label>
                        <input type="month" id="billingPeriodFrom" required onchange="updateBillingPeriod()">
                    </div>

                    <div class="form-group">
                        <label>Billing Period To *</label>
                        <input type="month" id="billingPeriodTo" required readonly>
                    </div>

                    <div class="form-group">
                        <label>Billing Date *</label>
                        <input type="date" id="billingDate" required>
                    </div>
                </div>

                <h4 style="margin: 20px 0;">Billing Heads</h4>
                
                <div id="billingHeadsContainer">
                    <!-- Dynamic billing heads will be added here -->
                </div>

                <button type="button" class="btn btn-sm" onclick="addBillingHead()">+ Add Billing Head</button>

                <div class="form-group" style="margin-top: 20px;">
                    <label>Bill Description</label>
                    <textarea id="billDescription" rows="3"></textarea>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success">Generate Bills for All Members</button>
                    <button type="button" class="btn" onclick="closeModal('billingModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Member Wise Billing Modal -->
    <div id="memberBillingModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('memberBillingModal')">&times;</span>
            <h2>Member-Wise Custom Billing</h2>
            <form id="memberBillingForm" onsubmit="generateMemberWiseBills(event)">
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Select Member *</label>
                        <select id="selectedMember" required>
                            <option value="">Select Member</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Billing Date *</label>
                        <input type="date" id="memberBillingDate" required>
                    </div>

                    <div class="form-group">
                        <label>Billing Period From *</label>
                        <input type="month" id="memberBillingFrom" required>
                    </div>

                    <div class="form-group">
                        <label>Billing Period To *</label>
                        <input type="month" id="memberBillingTo" required>
                    </div>
                </div>

                <h4 style="margin: 20px 0;">Custom Charges for This Member</h4>
                
                <div id="memberBillingHeadsContainer">
                    <!-- Dynamic billing heads for member -->
                </div>

                <button type="button" class="btn btn-sm" onclick="addMemberBillingHead()">+ Add Charge</button>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success">Generate Bill</button>
                    <button type="button" class="btn" onclick="closeModal('memberBillingModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Entry Modal -->
    <div id="entryModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('entryModal')">&times;</span>
            <h2 id="entryModalTitle">New Entry</h2>
            <form id="entryForm" onsubmit="saveEntry(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Entry Type *</label>
                        <select id="entryType" required>
                            <option value="receipt">Receipt</option>
                            <option value="payment">Payment</option>
                            <option value="journal">Journal</option>
                            <option value="contra">Contra</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Entry Date *</label>
                        <input type="date" id="entryDate" required>
                    </div>

                    <div class="form-group">
                        <label>Reference Number</label>
                        <input type="text" id="refNumber">
                    </div>
                </div>

                <h4 style="margin: 20px 0;">Double Entry Details</h4>
                
                <div id="entryLines">
                    <!-- Entry lines will be added here -->
                </div>

                <button type="button" class="btn btn-sm" onclick="addEntryLine()">+ Add Line</button>

                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                    <strong>Total Debit:</strong> <span id="totalDebit">‚Çπ0.00</span> | 
                    <strong>Total Credit:</strong> <span id="totalCredit">‚Çπ0.00</span> |
                    <strong>Difference:</strong> <span id="difference" style="color: red;">‚Çπ0.00</span>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success">Save Entry</button>
                    <button type="button" class="btn" onclick="closeModal('entryModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bank Reconciliation Modal -->
    <div id="bankReconciliationModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('bankReconciliationModal')">&times;</span>
            <h2>New Bank Reconciliation</h2>
            <form id="bankReconciliationForm" onsubmit="saveBankReconciliation(event)">
                <input type="hidden" id="reconciliationId">
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Bank Account *</label>
                        <select id="bankAccount" required>
                            <option value="">Select Bank Account</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Statement Date *</label>
                        <input type="date" id="statementDate" required>
                    </div>

                    <div class="form-group">
                        <label>Statement Balance *</label>
                        <input type="number" id="statementBalance" step="0.01" required>
                    </div>

                    <div class="form-group">
                        <label>Book Balance</label>
                        <input type="number" id="bookBalance" step="0.01" readonly>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success">Start Reconciliation</button>
                    <button type="button" class="btn" onclick="closeModal('bankReconciliationModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Database Configuration
        const DB_NAME = 'SocietyAccountingDB';
        const DB_VERSION = 4;
        let db;
        let currentSocietyId = null;

        // Initialize Database
        function initDB() {
            const request = indexedDB.open(DB_NAME, DB_VERSION);

            request.onerror = (event) => {
                showAlert('Database error: ' + event.target.error, 'error');
            };

            request.onsuccess = (event) => {
                db = event.target.result;
                console.log('Database initialized successfully');
                loadSocietiesIntoDropdown();
                checkSelectedSociety();
            };

            request.onupgradeneeded = (event) => {
                db = event.target.result;
                
                // Societies Store
                if (!db.objectStoreNames.contains('societies')) {
                    const societyStore = db.createObjectStore('societies', { 
                        keyPath: 'id', 
                        autoIncrement: true 
                    });
                    societyStore.createIndex('name', 'name', { unique: false });
                    societyStore.createIndex('regNumber', 'regNumber', { unique: true });
                }

                // Members Store
                if (!db.objectStoreNames.contains('members')) {
                    const memberStore = db.createObjectStore('members', { 
                        keyPath: 'id', 
                        autoIncrement: true 
                    });
                    memberStore.createIndex('societyId', 'societyId', { unique: false });
                    memberStore.createIndex('flatNo', 'flatNo', { unique: false });
                }

                // Accounts Store
                if (!db.objectStoreNames.contains('accounts')) {
                    const accountStore = db.createObjectStore('accounts', { 
                        keyPath: 'id', 
                        autoIncrement: true 
                    });
                    accountStore.createIndex('societyId', 'societyId', { unique: false });
                    accountStore.createIndex('group', 'group', { unique: false });
                }

                // Bills Store
                if (!db.objectStoreNames.contains('bills')) {
                    const billStore = db.createObjectStore('bills', { 
                        keyPath: 'id', 
                        autoIncrement: true 
                    });
                    billStore.createIndex('societyId', 'societyId', { unique: false });
                    billStore.createIndex('memberId', 'memberId', { unique: false });
                }

                // Entries Store
                if (!db.objectStoreNames.contains('entries')) {
                    const entryStore = db.createObjectStore('entries', { 
                        keyPath: 'id', 
                        autoIncrement: true 
                    });
                    entryStore.createIndex('societyId', 'societyId', { unique: false });
                    entryStore.createIndex('entryType', 'entryType', { unique: false });
                }

                // Journal Lines Store
                if (!db.objectStoreNames.contains('journalLines')) {
                    const lineStore = db.createObjectStore('journalLines', { 
                        keyPath: 'id', 
                        autoIncrement: true 
                    });
                    lineStore.createIndex('entryId', 'entryId', { unique: false });
                    lineStore.createIndex('accountId', 'accountId', { unique: false });
                }

                // Bank Reconciliation Store
                if (!db.objectStoreNames.contains('bankReconciliations')) {
                    const reconStore = db.createObjectStore('bankReconciliations', { 
                        keyPath: 'id', 
                        autoIncrement: true 
                    });
                    reconStore.createIndex('societyId', 'societyId', { unique: false });
                    reconStore.createIndex('accountId', 'accountId', { unique: false });
                }

                console.log('Database upgrade completed');
            };
        }

        // Navigation Function - FIXED
        function navigateTo(page) {
            // Remove active class from all menu items
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to clicked item
            event.target.closest('.menu-item').classList.add('active');

            // Update page title
            const titles = {
                'dashboard': 'Dashboard',
                'societies': 'Manage Societies',
                'members': 'Member Management',
                'accounts': 'Chart of Accounts',
                'billing': 'Billing & Invoicing',
                'entries': 'Accounting Entries',
                'bankreconciliation': 'Bank Reconciliation',
                'reports': 'Financial Reports',
                'backup': 'Backup & Export'
            };
            document.getElementById('pageTitle').textContent = titles[page] || page;

            // Load page content
            loadPageContent(page);
        }

        // Load Page Content
        function loadPageContent(page) {
            switch(page) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'societies':
                    loadSocietiesPage();
                    break;
                case 'members':
                    loadMembersPage();
                    break;
                case 'accounts':
                    loadAccountsPage();
                    break;
                case 'billing':
                    loadBillingPage();
                    break;
                case 'entries':
                    loadEntriesPage();
                    break;
                case 'bankreconciliation':
                    loadBankReconciliationPage();
                    break;
                case 'reports':
                    loadReportsPage();
                    break;
                case 'backup':
                    loadBackupPage();
                    break;
                default:
                    loadDashboard();
            }
        }

        // Load Dashboard - FIXED
        function loadDashboard() {
            if (!currentSocietyId) {
                document.getElementById('contentArea').innerHTML = `
                    <div style="text-align: center; padding: 60px;">
                        <h2 style="color: #999;">No Society Selected</h2>
                        <p>Please select a society from the dropdown above or create a new one.</p>
                        <button class="btn btn-success" onclick="navigateTo('societies')">Manage Societies</button>
                    </div>
                `;
                return;
            }

            const transaction = db.transaction(['members', 'accounts', 'entries'], 'readonly');
            const memberStore = transaction.objectStore('members');
            const accountStore = transaction.objectStore('accounts');
            const entryStore = transaction.objectStore('entries');

            const memberIndex = memberStore.index('societyId');
            const accountIndex = accountStore.index('societyId');
            const entryIndex = entryStore.index('societyId');

            const memberRequest = memberIndex.getAll(currentSocietyId);
            const accountRequest = accountIndex.getAll(currentSocietyId);
            const entryRequest = entryIndex.getAll(currentSocietyId);

            Promise.all([
                new Promise(resolve => { memberRequest.onsuccess = () => resolve(memberRequest.result); }),
                new Promise(resolve => { accountRequest.onsuccess = () => resolve(accountRequest.result); }),
                new Promise(resolve => { entryRequest.onsuccess = () => resolve(entryRequest.result); })
            ]).then(([members, accounts, entries]) => {
                const activeMembers = members.filter(m => m.status === 'active').length;
                
                document.getElementById('contentArea').innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>${members.length}</h3>
                            <p>Total Members</p>
                        </div>
                        <div class="stat-card">
                            <h3>${activeMembers}</h3>
                            <p>Active Members</p>
                        </div>
                        <div class="stat-card">
                            <h3>${accounts.length}</h3>
                            <p>Chart of Accounts</p>
                        </div>
                        <div class="stat-card">
                            <h3>${entries.length}</h3>
                            <p>Total Entries</p>
                        </div>
                    </div>

                    <h3 style="margin-top: 30px; margin-bottom: 20px;">Quick Actions</h3>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="navigateTo('members'); event.stopPropagation();">Add Member</button>
                        <button class="btn btn-success" onclick="navigateTo('accounts'); event.stopPropagation();">Setup Accounts</button>
                        <button class="btn" onclick="navigateTo('billing'); event.stopPropagation();">Generate Bills</button>
                        <button class="btn" onclick="navigateTo('entries'); event.stopPropagation();">New Entry</button>
                        <button class="btn" onclick="navigateTo('reports'); event.stopPropagation();">View Reports</button>
                    </div>

                    <h3 style="margin-top: 40px; margin-bottom: 20px;">Recent Entries</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Entry Type</th>
                                <th>Reference</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${entries.slice(-5).reverse().map(e => `
                                <tr>
                                    <td>${new Date(e.date).toLocaleDateString()}</td>
                                    <td><strong>${e.entryType.toUpperCase()}</strong></td>
                                    <td>${e.refNumber || 'N/A'}</td>
                                    <td>‚Çπ${e.amount.toFixed(2)}</td>
                                </tr>
                            `).join('') || '<tr><td colspan="4" style="text-align: center; color: #999;">No entries yet</td></tr>'}
                        </tbody>
                    </table>
                `;
            });
        }

        // Load Societies Page - FIXED WITH ADD/EDIT/DELETE
        function loadSocietiesPage() {
            const transaction = db.transaction(['societies'], 'readonly');
            const objectStore = transaction.objectStore('societies');
            const request = objectStore.getAll();

            request.onsuccess = () => {
                const societies = request.result;
                const activeSocieties = societies.filter(s => s.status === 'active').length;

                document.getElementById('contentArea').innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>${societies.length}</h3>
                            <p>Total Societies</p>
                        </div>
                        <div class="stat-card">
                            <h3>${activeSocieties}</h3>
                            <p>Active Societies</p>
                        </div>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>All Societies</h3>
                        <button class="btn btn-success" onclick="openAddSocietyModal()">+ Add New Society</button>
                    </div>

                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Society Name</th>
                                <th>Reg Number</th>
                                <th>City</th>
                                <th>Contact</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${societies.map(s => `
                                <tr>
                                    <td><strong>${s.name}</strong></td>
                                    <td>${s.regNumber}</td>
                                    <td>${s.city || 'N/A'}</td>
                                    <td>${s.mobile || 'N/A'}</td>
                                    <td><span style="color: ${s.status === 'active' ? 'green' : 'red'};">${s.status.toUpperCase()}</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-success" onclick="selectSocietyDirect(${s.id})">Select</button>
                                        <button class="btn btn-sm" onclick="editSociety(${s.id})">Edit</button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteSociety(${s.id})">Delete</button>
                                    </td>
                                </tr>
                            `).join('') || '<tr><td colspan="6" style="text-align: center; color: #999;">No societies found</td></tr>'}
                        </tbody>
                    </table>
                `;
            };
        }

        // Society Functions - FIXED
        function openAddSocietyModal() {
            document.getElementById('societyModalTitle').textContent = 'Add New Society';
            document.getElementById('societyForm').reset();
            document.getElementById('societyId').value = '';
            document.getElementById('societyModal').classList.add('active');
        }

        function saveSociety(event) {
            event.preventDefault();
            
            const society = {
                name: document.getElementById('societyName').value,
                regNumber: document.getElementById('regNumber').value,
                address: document.getElementById('address').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value,
                pincode: document.getElementById('pincode').value,
                contactPerson: document.getElementById('contactPerson').value,
                mobile: document.getElementById('mobile').value,
                email: document.getElementById('email').value,
                fyStart: document.getElementById('fyStart').value,
                status: document.getElementById('status').value,
                createdDate: new Date().toISOString(),
                modifiedDate: new Date().toISOString()
            };

            const societyId = document.getElementById('societyId').value;
            if (societyId) {
                society.id = parseInt(societyId);
            }

            const transaction = db.transaction(['societies'], 'readwrite');
            const objectStore = transaction.objectStore('societies');
            
            const request = societyId ? objectStore.put(society) : objectStore.add(society);

            request.onsuccess = () => {
                showAlert(societyId ? 'Society updated successfully!' : 'Society added successfully!', 'success');
                closeModal('societyModal');
                loadSocietiesIntoDropdown();
                loadSocietiesPage();
            };

            request.onerror = (event) => {
                showAlert('Error saving society: ' + event.target.error, 'error');
            };
        }

        function editSociety(id) {
            const transaction = db.transaction(['societies'], 'readonly');
            const objectStore = transaction.objectStore('societies');
            const request = objectStore.get(id);

            request.onsuccess = () => {
                const society = request.result;
                
                document.getElementById('societyModalTitle').textContent = 'Edit Society';
                document.getElementById('societyId').value = society.id;
                document.getElementById('societyName').value = society.name;
                document.getElementById('regNumber').value = society.regNumber;
                document.getElementById('address').value = society.address || '';
                document.getElementById('city').value = society.city || '';
                document.getElementById('state').value = society.state || '';
                document.getElementById('pincode').value = society.pincode || '';
                document.getElementById('contactPerson').value = society.contactPerson || '';
                document.getElementById('mobile').value = society.mobile || '';
                document.getElementById('email').value = society.email || '';
                document.getElementById('fyStart').value = society.fyStart;
                document.getElementById('status').value = society.status;
                
                document.getElementById('societyModal').classList.add('active');
            };
        }

        function deleteSociety(id) {
            if (!confirm('Are you sure you want to delete this society? All related data will be lost!')) return;

            const transaction = db.transaction(['societies'], 'readwrite');
            const objectStore = transaction.objectStore('societies');
            const request = objectStore.delete(id);

            request.onsuccess = () => {
                showAlert('Society deleted successfully!', 'success');
                loadSocietiesIntoDropdown();
                loadSocietiesPage();
                
                if (currentSocietyId === id) {
                    currentSocietyId = null;
                    localStorage.removeItem('selectedSocietyId');
                    document.getElementById('currentSocietyName').textContent = '';
                }
            };
        }

        // Load Members Page - FIXED
        function loadMembersPage() {
            if (!currentSocietyId) {
                document.getElementById('contentArea').innerHTML = '<p>Please select a society first</p>';
                return;
            }

            const transaction = db.transaction(['members'], 'readonly');
            const memberStore = transaction.objectStore('members');
            const index = memberStore.index('societyId');
            const request = index.getAll(currentSocietyId);

            request.onsuccess = () => {
                const members = request.result;
                const activeMembers = members.filter(m => m.status === 'active').length;

                document.getElementById('contentArea').innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>${members.length}</h3>
                            <p>Total Members</p>
                        </div>
                        <div class="stat-card">
                            <h3>${activeMembers}</h3>
                            <p>Active Members</p>
                        </div>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>All Members</h3>
                        <button class="btn btn-success" onclick="openAddMemberModal()">+ Add New Member</button>
                    </div>

                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Flat No</th>
                                <th>Member Name</th>
                                <th>Mobile</th>
                                <th>Email</th>
                                <th>Area (Sq.Ft.)</th>
                                <th>Share Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${members.map(m => `
                                <tr>
                                    <td><strong>${m.flatNo}</strong></td>
                                    <td>${m.name}</td>
                                    <td>${m.mobile}</td>
                                    <td>${m.email || 'N/A'}</td>
                                    <td>${m.area || 'N/A'}</td>
                                    <td>‚Çπ${m.shareAmount || 0}</td>
                                    <td><span style="color: ${m.status === 'active' ? 'green' : 'red'};">${m.status.toUpperCase()}</span></td>
                                    <td>
                                        <button class="btn btn-sm" onclick="editMember(${m.id})">Edit</button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteMember(${m.id})">Delete</button>
                                    </td>
                                </tr>
                            `).join('') || '<tr><td colspan="8" style="text-align: center; color: #999;">No members found. Add your first member!</td></tr>'}
                        </tbody>
                    </table>
                `;
            };
        }

        // Member Functions
        function openAddMemberModal() {
            document.getElementById('memberModalTitle').textContent = 'Add New Member';
            document.getElementById('memberForm').reset();
            document.getElementById('memberId').value = '';
            document.getElementById('memberModal').classList.add('active');
        }

        function saveMember(event) {
            event.preventDefault();
            
            const member = {
                societyId: currentSocietyId,
                name: document.getElementById('memberName').value,
                flatNo: document.getElementById('flatNo').value,
                mobile: document.getElementById('memberMobile').value,
                email: document.getElementById('memberEmail').value,
                area: document.getElementById('area').value,
                shareAmount: document.getElementById('shareAmount').value,
                openingBalance: document.getElementById('openingBalance').value,
                status: document.getElementById('memberStatus').value,
                createdDate: new Date().toISOString()
            };

            const memberId = document.getElementById('memberId').value;
            if (memberId) {
                member.id = parseInt(memberId);
            }

            const transaction = db.transaction(['members'], 'readwrite');
            const objectStore = transaction.objectStore('members');
            const request = memberId ? objectStore.put(member) : objectStore.add(member);

            request.onsuccess = () => {
                showAlert(memberId ? 'Member updated successfully!' : 'Member added successfully!', 'success');
                closeModal('memberModal');
                loadMembersPage();
            };

            request.onerror = (event) => {
                showAlert('Error saving member: ' + event.target.error, 'error');
            };
        }

        function editMember(id) {
            const transaction = db.transaction(['members'], 'readonly');
            const objectStore = transaction.objectStore('members');
            const request = objectStore.get(id);

            request.onsuccess = () => {
                const member = request.result;
                
                document.getElementById('memberModalTitle').textContent = 'Edit Member';
                document.getElementById('memberId').value = member.id;
                document.getElementById('memberName').value = member.name;
                document.getElementById('flatNo').value = member.flatNo;
                document.getElementById('memberMobile').value = member.mobile;
                document.getElementById('memberEmail').value = member.email || '';
                document.getElementById('area').value = member.area || '';
                document.getElementById('shareAmount').value = member.shareAmount || '';
                document.getElementById('openingBalance').value = member.openingBalance || 0;
                document.getElementById('memberStatus').value = member.status;
                
                document.getElementById('memberModal').classList.add('active');
            };
        }

        function deleteMember(id) {
            if (!confirm('Are you sure you want to delete this member?')) return;

            const transaction = db.transaction(['members'], 'readwrite');
            const objectStore = transaction.objectStore('members');
            const request = objectStore.delete(id);

            request.onsuccess = () => {
                showAlert('Member deleted successfully!', 'success');
                loadMembersPage();
            };
        }

        // Load Chart of Accounts Page - FIXED
        function loadAccountsPage() {
            if (!currentSocietyId) {
                document.getElementById('contentArea').innerHTML = '<p>Please select a society first</p>';
                return;
            }

            const transaction = db.transaction(['accounts'], 'readonly');
            const accountStore = transaction.objectStore('accounts');
            const index = accountStore.index('societyId');
            const request = index.getAll(currentSocietyId);

            request.onsuccess = () => {
                const accounts = request.result;
                
                // Group accounts by main group
                const groupedAccounts = accounts.reduce((acc, account) => {
                    if (!acc[account.group]) acc[account.group] = [];
                    acc[account.group].push(account);
                    return acc;
                }, {});

                let tableHTML = '';
                ['Assets', 'Liabilities', 'Income', 'Expenses'].forEach(group => {
                    const groupAccounts = groupedAccounts[group] || [];
                    tableHTML += `
                        <tr style="background: #667eea; color: white; font-weight: bold;">
                            <td colspan="6">${group} (${groupAccounts.length})</td>
                        </tr>
                        ${groupAccounts.map(a => `
                            <tr>
                                <td style="padding-left: 30px;">${a.code || '-'}</td>
                                <td>${a.name}</td>
                                <td>${a.subGroup || '-'}</td>
                                <td>‚Çπ${a.openingBalance || 0}</td>
                                <td>${a.balanceType}</td>
                                <td>
                                    <button class="btn btn-sm" onclick="editAccount(${a.id})">Edit</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteAccount(${a.id})">Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    `;
                });

                document.getElementById('contentArea').innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <h3>Chart of Accounts</h3>
                            <p style="color: #666; margin-top: 5px;">Define all ledger accounts for accounting entries</p>
                        </div>
                        <button class="btn btn-success" onclick="openAddAccountModal()">+ Add New Account</button>
                    </div>

                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Account Name</th>
                                <th>Sub Group</th>
                                <th>Opening Balance</th>
                                <th>Type</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableHTML || '<tr><td colspan="6" style="text-align: center; color: #999;">No accounts found. Add your first account!</td></tr>'}
                        </tbody>
                    </table>

                    <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                        <h4>Suggested Accounts for Housing Society</h4>
                        <p style="margin: 10px 0;">Click to add standard accounts:</p>
                        <button class="btn btn-sm btn-success" onclick="addStandardAccounts()">Add Standard Accounts</button>
                    </div>
                `;
            };
        }

        // Account Functions
        function openAddAccountModal() {
            document.getElementById('accountModalTitle').textContent = 'Add New Account';
            document.getElementById('accountForm').reset();
            document.getElementById('accountId').value = '';
            document.getElementById('accountModal').classList.add('active');
        }

        function saveAccount(event) {
            event.preventDefault();
            
            const account = {
                societyId: currentSocietyId,
                group: document.getElementById('accountGroup').value,
                subGroup: document.getElementById('subGroup').value,
                name: document.getElementById('accountName').value,
                code: document.getElementById('accountCode').value,
                openingBalance: document.getElementById('accountOpeningBalance').value,
                balanceType: document.getElementById('balanceType').value,
                createdDate: new Date().toISOString()
            };

            const accountId = document.getElementById('accountId').value;
            if (accountId) {
                account.id = parseInt(accountId);
            }

            const transaction = db.transaction(['accounts'], 'readwrite');
            const objectStore = transaction.objectStore('accounts');
            const request = accountId ? objectStore.put(account) : objectStore.add(account);

            request.onsuccess = () => {
                showAlert(accountId ? 'Account updated successfully!' : 'Account added successfully!', 'success');
                closeModal('accountModal');
                loadAccountsPage();
            };

            request.onerror = (event) => {
                showAlert('Error saving account: ' + event.target.error, 'error');
            };
        }

        function editAccount(id) {
            const transaction = db.transaction(['accounts'], 'readonly');
            const objectStore = transaction.objectStore('accounts');
            const request = objectStore.get(id);

            request.onsuccess = () => {
                const account = request.result;
                
                document.getElementById('accountModalTitle').textContent = 'Edit Account';
                document.getElementById('accountId').value = account.id;
                document.getElementById('accountGroup').value = account.group;
                document.getElementById('subGroup').value = account.subGroup || '';
                document.getElementById('accountName').value = account.name;
                document.getElementById('accountCode').value = account.code || '';
                document.getElementById('accountOpeningBalance').value = account.openingBalance || 0;
                document.getElementById('balanceType').value = account.balanceType;
                
                document.getElementById('accountModal').classList.add('active');
            };
        }

        function deleteAccount(id) {
            if (!confirm('Are you sure you want to delete this account?')) return;

            const transaction = db.transaction(['accounts'], 'readwrite');
            const objectStore = transaction.objectStore('accounts');
            const request = objectStore.delete(id);

            request.onsuccess = () => {
                showAlert('Account deleted successfully!', 'success');
                loadAccountsPage();
            };
        }

        function addStandardAccounts() {
            const standardAccounts = [
                { group: 'Assets', subGroup: 'Current Assets', name: 'Cash in Hand', code: '1001', balanceType: 'debit', openingBalance: 0 },
                { group: 'Assets', subGroup: 'Current Assets', name: 'Bank Account - SBI', code: '1002', balanceType: 'debit', openingBalance: 0 },
                { group: 'Assets', subGroup: 'Current Assets', name: 'Members Outstanding', code: '1010', balanceType: 'debit', openingBalance: 0 },
                { group: 'Assets', subGroup: 'Fixed Assets', name: 'Building', code: '1100', balanceType: 'debit', openingBalance: 0 },
                { group: 'Liabilities', subGroup: 'Current Liabilities', name: 'Sundry Creditors', code: '2001', balanceType: 'credit', openingBalance: 0 },
                { group: 'Liabilities', subGroup: 'Reserves', name: 'Corpus Fund', code: '2100', balanceType: 'credit', openingBalance: 0 },
                { group: 'Income', subGroup: 'Member Contributions', name: 'Maintenance Charges', code: '4001', balanceType: 'credit', openingBalance: 0 },
                { group: 'Income', subGroup: 'Member Contributions', name: 'Water Charges', code: '4002', balanceType: 'credit', openingBalance: 0 },
                { group: 'Income', subGroup: 'Other Income', name: 'Interest Income', code: '4100', balanceType: 'credit', openingBalance: 0 },
                { group: 'Expenses', subGroup: 'Operating Expenses', name: 'Electricity Charges', code: '5001', balanceType: 'debit', openingBalance: 0 },
                { group: 'Expenses', subGroup: 'Operating Expenses', name: 'Water Charges - Municipal', code: '5002', balanceType: 'debit', openingBalance: 0 },
                { group: 'Expenses', subGroup: 'Operating Expenses', name: 'Staff Salaries', code: '5010', balanceType: 'debit', openingBalance: 0 },
                { group: 'Expenses', subGroup: 'Operating Expenses', name: 'Repairs & Maintenance', code: '5020', balanceType: 'debit', openingBalance: 0 },
            ];

            const transaction = db.transaction(['accounts'], 'readwrite');
            const objectStore = transaction.objectStore('accounts');

            let addedCount = 0;
            standardAccounts.forEach(account => {
                account.societyId = currentSocietyId;
                account.createdDate = new Date().toISOString();
                
                const request = objectStore.add(account);
                request.onsuccess = () => {
                    addedCount++;
                    if (addedCount === standardAccounts.length) {
                        showAlert(`${addedCount} standard accounts added successfully!`, 'success');
                        loadAccountsPage();
                    }
                };
                request.onerror = () => {
                    addedCount++; // Skip duplicates
                    if (addedCount === standardAccounts.length) {
                        showAlert(`Standard accounts added (some may have been skipped if duplicates)`, 'success');
                        loadAccountsPage();
                    }
                };
            });
        }

        // BILLING MODULE - COMPLETE REWRITE WITH ALL FEATURES
        function loadBillingPage() {
            if (!currentSocietyId) {
                document.getElementById('contentArea').innerHTML = '<p>Please select a society first</p>';
                return;
            }

            const transaction = db.transaction(['bills'], 'readonly');
            const billStore = transaction.objectStore('bills');
            const index = billStore.index('societyId');
            const request = index.getAll(currentSocietyId);

            request.onsuccess = () => {
                const bills = request.result;
                const totalAmount = bills.reduce((sum, b) => sum + b.totalAmount, 0);
                const paidAmount = bills.filter(b => b.status === 'paid').reduce((sum, b) => sum + b.totalAmount, 0);
                const pendingAmount = totalAmount - paidAmount;

                document.getElementById('contentArea').innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>${bills.length}</h3>
                            <p>Total Bills</p>
                        </div>
                        <div class="stat-card">
                            <h3>‚Çπ${totalAmount.toFixed(2)}</h3>
                            <p>Total Amount</p>
                        </div>
                        <div class="stat-card">
                            <h3>‚Çπ${paidAmount.toFixed(2)}</h3>
                            <p>Paid Amount</p>
                        </div>
                        <div class="stat-card">
                            <h3>‚Çπ${pendingAmount.toFixed(2)}</h3>
                            <p>Pending Amount</p>
                        </div>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>All Bills</h3>
                        <div>
                            <button class="btn btn-success" onclick="openBulkBillingModal()">Generate Bulk Bills</button>
                            <button class="btn" onclick="openMemberWiseBillingModal()">Member-Wise Billing</button>
                        </div>
                    </div>

                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Billing Period</th>
                                <th>Member</th>
                                <th>Flat No</th>
                                <th>Bill Details</th>
                                <th>Total Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${bills.map(b => `
                                <tr>
                                    <td>${b.periodFrom} to ${b.periodTo}</td>
                                    <td>${b.memberName}</td>
                                    <td>${b.flatNo}</td>
                                    <td>
                                        ${b.charges ? Object.entries(b.charges).map(([head, amount]) => 
                                            `${head}: ‚Çπ${amount}`
                                        ).join('<br>') : 'N/A'}
                                    </td>
                                    <td><strong>‚Çπ${b.totalAmount.toFixed(2)}</strong></td>
                                    <td><span style="color: ${b.status === 'paid' ? 'green' : 'orange'};">${b.status.toUpperCase()}</span></td>
                                    <td>
                                        <button class="btn btn-sm" onclick="markAsPaid(${b.id})">Mark Paid</button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteBill(${b.id})">Delete</button>
                                    </td>
                                </tr>
                            `).join('') || '<tr><td colspan="7" style="text-align: center; color: #999;">No bills generated yet</td></tr>'}
                        </tbody>
                    </table>
                `;
            };
        }

        // Open Bulk Billing Modal
        function openBulkBillingModal() {
            document.getElementById('billingForm').reset();
            const today = new Date();
            document.getElementById('billingPeriodFrom').value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            document.getElementById('billingDate').value = today.toISOString().split('T')[0];
            
            // Initialize with 3 default billing heads
            document.getElementById('billingHeadsContainer').innerHTML = '';
            addBillingHead();
            addBillingHead();
            addBillingHead();
            
            updateBillingPeriod();
            document.getElementById('billingModal').classList.add('active');
        }

        // Update Billing Period Based on Frequency
        function updateBillingPeriod() {
            const frequency = document.getElementById('billingFrequency').value;
            const fromDate = new Date(document.getElementById('billingPeriodFrom').value + '-01');
            
            if (!fromDate || isNaN(fromDate)) return;
            
            let toDate = new Date(fromDate);
            
            switch(frequency) {
                case 'monthly':
                    toDate.setMonth(toDate.getMonth() + 1);
                    break;
                case 'bimonthly':
                    toDate.setMonth(toDate.getMonth() + 2);
                    break;
                case 'quarterly':
                    toDate.setMonth(toDate.getMonth() + 3);
                    break;
                case 'halfyearly':
                    toDate.setMonth(toDate.getMonth() + 6);
                    break;
                case 'yearly':
                    toDate.setMonth(toDate.getMonth() + 12);
                    break;
            }
            
            toDate.setDate(0); // Last day of previous month
            const toMonth = String(toDate.getMonth() + 1).padStart(2, '0');
            document.getElementById('billingPeriodTo').value = `${toDate.getFullYear()}-${toMonth}`;
        }

        // Add Billing Head (Dynamic Form Field)
        function addBillingHead() {
            const container = document.getElementById('billingHeadsContainer');
            const row = document.createElement('div');
            row.className = 'billing-head-row';
            row.innerHTML = `
                <div class="form-group" style="margin: 0;">
                    <label>Billing Head Name</label>
                    <input type="text" class="billing-head-name" placeholder="e.g., Maintenance, Water" required>
                </div>
                <div class="form-group" style="margin: 0;">
                    <label>Calculation Type</label>
                    <select class="billing-calc-type" onchange="toggleRateField(this)">
                        <option value="fixed">Fixed Amount</option>
                        <option value="perarea">Per Sq. Ft.</option>
                    </select>
                </div>
                <div class="form-group billing-rate-group" style="margin: 0;">
                    <label>Amount/Rate</label>
                    <input type="number" class="billing-head-rate" step="0.01" placeholder="0.00" required>
                </div>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeBillingHead(this)" style="margin-top: 25px;">√ó</button>
            `;
            container.appendChild(row);
        }

        function removeBillingHead(btn) {
            const container = document.getElementById('billingHeadsContainer');
            if (container.children.length > 1) {
                btn.closest('.billing-head-row').remove();
            } else {
                showAlert('At least one billing head is required', 'error');
            }
        }

        function toggleRateField(select) {
            // Can be used for future enhancements
        }

        // Generate Bulk Bills
        function generateBills(event) {
            event.preventDefault();

            const frequency = document.getElementById('billingFrequency').value;
            const periodFrom = document.getElementById('billingPeriodFrom').value;
            const periodTo = document.getElementById('billingPeriodTo').value;
            const billingDate = document.getElementById('billingDate').value;
            const description = document.getElementById('billDescription').value;

            // Collect billing heads
            const billingHeads = [];
            const headRows = document.querySelectorAll('.billing-head-row');
            
            headRows.forEach(row => {
                const name = row.querySelector('.billing-head-name').value;
                const calcType = row.querySelector('.billing-calc-type').value;
                const rate = parseFloat(row.querySelector('.billing-head-rate').value);
                
                if (name && rate) {
                    billingHeads.push({ name, calcType, rate });
                }
            });

            if (billingHeads.length === 0) {
                showAlert('Please add at least one billing head', 'error');
                return;
            }

            // Get all active members
            const transaction = db.transaction(['members', 'bills'], 'readwrite');
            const memberStore = transaction.objectStore('members');
            const billStore = transaction.objectStore('bills');
            const index = memberStore.index('societyId');
            const request = index.getAll(currentSocietyId);

            request.onsuccess = () => {
                const members = request.result.filter(m => m.status === 'active');
                let billCount = 0;

                members.forEach(member => {
                    const area = parseFloat(member.area) || 0;
                    const charges = {};
                    let totalAmount = 0;

                    // Calculate charges for each billing head
                    billingHeads.forEach(head => {
                        let amount = 0;
                        if (head.calcType === 'fixed') {
                            amount = head.rate;
                        } else if (head.calcType === 'perarea') {
                            amount = area * head.rate;
                        }
                        charges[head.name] = amount;
                        totalAmount += amount;
                    });

                    const bill = {
                        societyId: currentSocietyId,
                        memberId: member.id,
                        memberName: member.name,
                        flatNo: member.flatNo,
                        frequency: frequency,
                        periodFrom: periodFrom,
                        periodTo: periodTo,
                        billingDate: billingDate,
                        charges: charges,
                        totalAmount: totalAmount,
                        status: 'pending',
                        description: description,
                        createdDate: new Date().toISOString()
                    };

                    const addRequest = billStore.add(bill);
                    addRequest.onsuccess = () => {
                        billCount++;
                        if (billCount === members.length) {
                            showAlert(`${billCount} bills generated successfully!`, 'success');
                            closeModal('billingModal');
                            loadBillingPage();
                        }
                    };
                });

                if (members.length === 0) {
                    showAlert('No active members found', 'error');
                }
            };
        }

        // Open Member-Wise Billing Modal
        function openMemberWiseBillingModal() {
            // Load members into dropdown
            const transaction = db.transaction(['members'], 'readonly');
            const memberStore = transaction.objectStore('members');
            const index = memberStore.index('societyId');
            const request = index.getAll(currentSocietyId);

            request.onsuccess = () => {
                const members = request.result.filter(m => m.status === 'active');
                const select = document.getElementById('selectedMember');
                
                select.innerHTML = '<option value="">Select Member</option>';
                members.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = `${member.flatNo} - ${member.name}`;
                    option.dataset.area = member.area || 0;
                    select.appendChild(option);
                });

                // Initialize billing heads
                document.getElementById('memberBillingHeadsContainer').innerHTML = '';
                addMemberBillingHead();
                addMemberBillingHead();

                const today = new Date();
                document.getElementById('memberBillingDate').value = today.toISOString().split('T')[0];
                document.getElementById('memberBillingFrom').value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
                document.getElementById('memberBillingTo').value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
                
                document.getElementById('memberBillingModal').classList.add('active');
            };
        }

        function addMemberBillingHead() {
            const container = document.getElementById('memberBillingHeadsContainer');
            const row = document.createElement('div');
            row.className = 'billing-head-row';
            row.innerHTML = `
                <div class="form-group" style="margin: 0;">
                    <label>Charge Name</label>
                    <input type="text" class="member-billing-head-name" placeholder="e.g., Maintenance, Penalty" required>
                </div>
                <div class="form-group" style="margin: 0;">
                    <label>Calculation</label>
                    <select class="member-billing-calc-type">
                        <option value="fixed">Fixed Amount</option>
                        <option value="perarea">Per Sq. Ft.</option>
                    </select>
                </div>
                <div class="form-group" style="margin: 0;">
                    <label>Amount/Rate</label>
                    <input type="number" class="member-billing-head-rate" step="0.01" placeholder="0.00" required>
                </div>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeMemberBillingHead(this)" style="margin-top: 25px;">√ó</button>
            `;
            container.appendChild(row);
        }

        function removeMemberBillingHead(btn) {
            const container = document.getElementById('memberBillingHeadsContainer');
            if (container.children.length > 1) {
                btn.closest('.billing-head-row').remove();
            } else {
                showAlert('At least one charge is required', 'error');
            }
        }

        function generateMemberWiseBills(event) {
            event.preventDefault();

            const memberId = parseInt(document.getElementById('selectedMember').value);
            const select = document.getElementById('selectedMember');
            const selectedOption = select.options[select.selectedIndex];
            const memberName = selectedOption.textContent;
            const area = parseFloat(selectedOption.dataset.area) || 0;
            
            const billingDate = document.getElementById('memberBillingDate').value;
            const periodFrom = document.getElementById('memberBillingFrom').value;
            const periodTo = document.getElementById('memberBillingTo').value;

            // Collect billing heads
            const billingHeads = [];
            const headRows = document.querySelectorAll('#memberBillingHeadsContainer .billing-head-row');
            
            headRows.forEach(row => {
                const name = row.querySelector('.member-billing-head-name').value;
                const calcType = row.querySelector('.member-billing-calc-type').value;
                const rate = parseFloat(row.querySelector('.member-billing-head-rate').value);
                
                if (name && rate) {
                    billingHeads.push({ name, calcType, rate });
                }
            });

            if (billingHeads.length === 0) {
                showAlert('Please add at least one charge', 'error');
                return;
            }

            const charges = {};
            let totalAmount = 0;

            // Calculate charges
            billingHeads.forEach(head => {
                let amount = 0;
                if (head.calcType === 'fixed') {
                    amount = head.rate;
                } else if (head.calcType === 'perarea') {
                    amount = area * head.rate;
                }
                charges[head.name] = amount;
                totalAmount += amount;
            });

            // Get member details
            const transaction = db.transaction(['members', 'bills'], 'readwrite');
            const memberStore = transaction.objectStore('members');
            const billStore = transaction.objectStore('bills');
            
            const memberRequest = memberStore.get(memberId);
            
            memberRequest.onsuccess = () => {
                const member = memberRequest.result;
                
                const bill = {
                    societyId: currentSocietyId,
                    memberId: member.id,
                    memberName: member.name,
                    flatNo: member.flatNo,
                    frequency: 'custom',
                    periodFrom: periodFrom,
                    periodTo: periodTo,
                    billingDate: billingDate,
                    charges: charges,
                    totalAmount: totalAmount,
                    status: 'pending',
                    description: 'Member-wise custom billing',
                    createdDate: new Date().toISOString()
                };

                const addRequest = billStore.add(bill);
                
                addRequest.onsuccess = () => {
                    showAlert('Bill generated successfully!', 'success');
                    closeModal('memberBillingModal');
                    loadBillingPage();
                };

                addRequest.onerror = () => {
                    showAlert('Error generating bill', 'error');
                };
            };
        }

        function markAsPaid(billId) {
            const transaction = db.transaction(['bills'], 'readwrite');
            const billStore = transaction.objectStore('bills');
            const request = billStore.get(billId);

            request.onsuccess = () => {
                const bill = request.result;
                bill.status = 'paid';
                bill.paidDate = new Date().toISOString();
                
                const updateRequest = billStore.put(bill);
                updateRequest.onsuccess = () => {
                    showAlert('Bill marked as paid!', 'success');
                    loadBillingPage();
                };
            };
        }

        function deleteBill(billId) {
            if (!confirm('Are you sure you want to delete this bill?')) return;

            const transaction = db.transaction(['bills'], 'readwrite');
            const billStore = transaction.objectStore('bills');
            const request = billStore.delete(billId);

            request.onsuccess = () => {
                showAlert('Bill deleted successfully!', 'success');
                loadBillingPage();
            };
        }

        // ENTRIES MODULE - FIXED WITH ACCOUNT SELECTION
        function loadEntriesPage() {
            if (!currentSocietyId) {
                document.getElementById('contentArea').innerHTML = '<p>Please select a society first</p>';
                return;
            }

            const transaction = db.transaction(['entries'], 'readonly');
            const entryStore = transaction.objectStore('entries');
            const index = entryStore.index('societyId');
            const request = index.getAll(currentSocietyId);

            request.onsuccess = () => {
                const entries = request.result;
                const receipts = entries.filter(e => e.entryType === 'receipt');
                const payments = entries.filter(e => e.entryType === 'payment');

                document.getElementById('contentArea').innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>${entries.length}</h3>
                            <p>Total Entries</p>
                        </div>
                        <div class="stat-card">
                            <h3>${receipts.length}</h3>
                            <p>Receipts</p>
                        </div>
                        <div class="stat-card">
                            <h3>${payments.length}</h3>
                            <p>Payments</p>
                        </div>
                        <div class="stat-card">
                            <h3>‚Çπ${entries.reduce((sum, e) => sum + e.amount, 0).toFixed(2)}</h3>
                            <p>Total Amount</p>
                        </div>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>All Entries</h3>
                        <button class="btn btn-success" onclick="openEntryModal()">+ New Entry</button>
                    </div>

                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Reference</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${entries.reverse().map(e => `
                                <tr>
                                    <td>${new Date(e.date).toLocaleDateString()}</td>
                                    <td><strong>${e.entryType.toUpperCase()}</strong></td>
                                    <td>${e.refNumber || 'N/A'}</td>
                                    <td>‚Çπ${e.amount.toFixed(2)}</td>
                                    <td><span style="color: green;">POSTED</span></td>
                                    <td>
                                        <button class="btn btn-sm" onclick="viewEntry(${e.id})">View</button>
                                    </td>
                                </tr>
                            `).join('') || '<tr><td colspan="6" style="text-align: center; color: #999;">No entries found. Create your first entry!</td></tr>'}
                        </tbody>
                    </table>
                `;
            };
        }

        // Open Entry Modal - FIXED
        function openEntryModal() {
            document.getElementById('entryModalTitle').textContent = 'New Entry';
            document.getElementById('entryForm').reset();
            document.getElementById('entryDate').value = new Date().toISOString().split('T')[0];
            
            // Reset entry lines
            document.getElementById('entryLines').innerHTML = '';
            addEntryLine();
            addEntryLine();
            
            // Load accounts into dropdowns
            loadAccountsIntoEntryForm();
            
            document.getElementById('entryModal').classList.add('active');
        }

        // Load Accounts into Entry Form - FIXED
        function loadAccountsIntoEntryForm() {
            const transaction = db.transaction(['accounts'], 'readonly');
            const accountStore = transaction.objectStore('accounts');
            const index = accountStore.index('societyId');
            const request = index.getAll(currentSocietyId);

            request.onsuccess = () => {
                const accounts = request.result;
                
                // Update all account select elements
                setTimeout(() => {
                    const selects = document.querySelectorAll('.entry-account');
                    selects.forEach(select => {
                        select.innerHTML = '<option value="">Select Account</option>';
                        accounts.forEach(account => {
                            const option = document.createElement('option');
                            option.value = account.id;
                            option.textContent = `${account.name} (${account.group})`;
                            select.appendChild(option);
                        });
                    });
                }, 100);
            };
        }

        // Add Entry Line - FIXED
        function addEntryLine() {
            const container = document.getElementById('entryLines');
            const row = document.createElement('div');
            row.className = 'entry-row';
            row.innerHTML = `
                <div class="form-group" style="margin: 0;">
                    <select class="entry-account" required>
                        <option value="">Select Account</option>
                    </select>
                </div>
                <div class="form-group" style="margin: 0;">
                    <input type="text" class="entry-description" placeholder="Description">
                </div>
                <div class="form-group" style="margin: 0;">
                    <input type="number" class="entry-debit" step="0.01" value="0" onchange="updateTotals()">
                </div>
                <div class="form-group" style="margin: 0;">
                    <input type="number" class="entry-credit" step="0.01" value="0" onchange="updateTotals()">
                </div>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeEntryLine(this)">√ó</button>
            `;
            container.appendChild(row);
            
            // Load accounts into this new line
            loadAccountsIntoEntryForm();
        }

        function removeEntryLine(btn) {
            const container = document.getElementById('entryLines');
            if (container.children.length > 2) {
                btn.closest('.entry-row').remove();
                updateTotals();
            } else {
                showAlert('Minimum 2 lines required for double entry', 'error');
            }
        }

        function updateTotals() {
            const debits = document.querySelectorAll('.entry-debit');
            const credits = document.querySelectorAll('.entry-credit');
            
            let totalDebit = 0;
            let totalCredit = 0;
            
            debits.forEach(input => {
                totalDebit += parseFloat(input.value) || 0;
            });
            
            credits.forEach(input => {
                totalCredit += parseFloat(input.value) || 0;
            });
            
            document.getElementById('totalDebit').textContent = `‚Çπ${totalDebit.toFixed(2)}`;
            document.getElementById('totalCredit').textContent = `‚Çπ${totalCredit.toFixed(2)}`;
            
            const difference = Math.abs(totalDebit - totalCredit);
            document.getElementById('difference').textContent = `‚Çπ${difference.toFixed(2)}`;
            document.getElementById('difference').style.color = difference === 0 ? 'green' : 'red';
        }

        function saveEntry(event) {
            event.preventDefault();

            // Validate double entry
            const debits = Array.from(document.querySelectorAll('.entry-debit')).map(el => parseFloat(el.value) || 0);
            const credits = Array.from(document.querySelectorAll('.entry-credit')).map(el => parseFloat(el.value) || 0);
            
            const totalDebit = debits.reduce((sum, val) => sum + val, 0);
            const totalCredit = credits.reduce((sum, val) => sum + val, 0);
            
            if (Math.abs(totalDebit - totalCredit) > 0.01) {
                showAlert('Entry is not balanced! Debits must equal Credits', 'error');
                return;
            }

            const entry = {
                societyId: currentSocietyId,
                entryType: document.getElementById('entryType').value,
                date: document.getElementById('entryDate').value,
                refNumber: document.getElementById('refNumber').value,
                amount: totalDebit,
                createdDate: new Date().toISOString()
            };

            const transaction = db.transaction(['entries', 'journalLines'], 'readwrite');
            const entryStore = transaction.objectStore('entries');
            const lineStore = transaction.objectStore('journalLines');
            
            const entryRequest = entryStore.add(entry);

            entryRequest.onsuccess = () => {
                const entryId = entryRequest.result;
                
                // Save all journal lines
                const rows = document.querySelectorAll('.entry-row');
                let lineCount = 0;
                let linesToSave = 0;
                
                rows.forEach(row => {
                    const accountId = parseInt(row.querySelector('.entry-account').value);
                    const description = row.querySelector('.entry-description').value;
                    const debit = parseFloat(row.querySelector('.entry-debit').value) || 0;
                    const credit = parseFloat(row.querySelector('.entry-credit').value) || 0;
                    
                    if (accountId && (debit > 0 || credit > 0)) {
                        linesToSave++;
                        const line = {
                            entryId: entryId,
                            accountId: accountId,
                            description: description,
                            debit: debit,
                            credit: credit
                        };
                        
                        const lineRequest = lineStore.add(line);
                        lineRequest.onsuccess = () => {
                            lineCount++;
                            if (lineCount === linesToSave) {
                                showAlert('Entry posted successfully!', 'success');
                                closeModal('entryModal');
                                loadEntriesPage();
                            }
                        };
                    }
                });
            };

            entryRequest.onerror = () => {
                showAlert('Error posting entry', 'error');
            };
        }

        function viewEntry(id) {
            showAlert('Entry details view coming soon!', 'error');
        }

        // BANK RECONCILIATION MODULE - NEW
        function loadBankReconciliationPage() {
            if (!currentSocietyId) {
                document.getElementById('contentArea').innerHTML = '<p>Please select a society first</p>';
                return;
            }

            const transaction = db.transaction(['bankReconciliations'], 'readonly');
            const reconStore = transaction.objectStore('bankReconciliations');
            const index = reconStore.index('societyId');
            const request = index.getAll(currentSocietyId);

            request.onsuccess = () => {
                const reconciliations = request.result;

                document.getElementById('contentArea').innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <h3>Bank Reconciliation</h3>
                            <p style="color: #666; margin-top: 5px;">Match your book records with bank statements</p>
                        </div>
                        <button class="btn btn-success" onclick="openBankReconciliationModal()">+ New Reconciliation</button>
                    </div>

                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Bank Account</th>
                                <th>Statement Date</th>
                                <th>Statement Balance</th>
                                <th>Book Balance</th>
                                <th>Difference</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${reconciliations.map(r => {
                                const diff = Math.abs(r.statementBalance - r.bookBalance);
                                const status = diff < 0.01 ? 'Reconciled' : 'Pending';
                                return `
                                <tr>
                                    <td>${r.bankAccountName}</td>
                                    <td>${new Date(r.statementDate).toLocaleDateString()}</td>
                                    <td>‚Çπ${r.statementBalance.toFixed(2)}</td>
                                    <td>‚Çπ${r.bookBalance.toFixed(2)}</td>
                                    <td style="color: ${diff < 0.01 ? 'green' : 'red'};">‚Çπ${diff.toFixed(2)}</td>
                                    <td><span style="color: ${diff < 0.01 ? 'green' : 'orange'};">${status}</span></td>
                                    <td>
                                        <button class="btn btn-sm" onclick="viewReconciliation(${r.id})">View</button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteReconciliation(${r.id})">Delete</button>
                                    </td>
                                </tr>
                            `}).join('') || '<tr><td colspan="7" style="text-align: center; color: #999;">No reconciliations found. Start your first reconciliation!</td></tr>'}
                        </tbody>
                    </table>

                    <div style="margin-top: 40px; padding: 30px; background: #f8f9fa; border-radius: 10px;">
                        <h4>How Bank Reconciliation Works</h4>
                        <ol style="margin-top: 15px; padding-left: 20px;">
                            <li>Select your bank account</li>
                            <li>Enter statement date and closing balance from bank statement</li>
                            <li>System automatically calculates book balance from your entries</li>
                            <li>Match transactions and identify differences</li>
                            <li>Record adjustment entries if needed</li>
                        </ol>
                    </div>
                `;
            };
        }

        function openBankReconciliationModal() {
            // Load bank accounts
            const transaction = db.transaction(['accounts'], 'readonly');
            const accountStore = transaction.objectStore('accounts');
            const index = accountStore.index('societyId');
            const request = index.getAll(currentSocietyId);

            request.onsuccess = () => {
                const accounts = request.result;
                const bankAccounts = accounts.filter(a => 
                    a.name.toLowerCase().includes('bank') || 
                    a.subGroup?.toLowerCase().includes('bank')
                );

                const select = document.getElementById('bankAccount');
                select.innerHTML = '<option value="">Select Bank Account</option>';
                
                bankAccounts.forEach(account => {
                    const option = document.createElement('option');
                    option.value = account.id;
                    option.textContent = account.name;
                    option.dataset.balance = account.openingBalance || 0;
                    select.appendChild(option);
                });

                const today = new Date();
                document.getElementById('statementDate').value = today.toISOString().split('T')[0];
                
                document.getElementById('bankReconciliationModal').classList.add('active');
            };
        }

        function saveBankReconciliation(event) {
            event.preventDefault();

            const accountId = parseInt(document.getElementById('bankAccount').value);
            const select = document.getElementById('bankAccount');
            const selectedOption = select.options[select.selectedIndex];
            const accountName = selectedOption.textContent;
            const bookBalance = parseFloat(selectedOption.dataset.balance);
            
            const statementDate = document.getElementById('statementDate').value;
            const statementBalance = parseFloat(document.getElementById('statementBalance').value);

            const reconciliation = {
                societyId: currentSocietyId,
                accountId: accountId,
                bankAccountName: accountName,
                statementDate: statementDate,
                statementBalance: statementBalance,
                bookBalance: bookBalance,
                difference: Math.abs(statementBalance - bookBalance),
                status: Math.abs(statementBalance - bookBalance) < 0.01 ? 'reconciled' : 'pending',
                createdDate: new Date().toISOString()
            };

            const transaction = db.transaction(['bankReconciliations'], 'readwrite');
            const reconStore = transaction.objectStore('bankReconciliations');
            const request = reconStore.add(reconciliation);

            request.onsuccess = () => {
                showAlert('Bank reconciliation created successfully!', 'success');
                closeModal('bankReconciliationModal');
                loadBankReconciliationPage();
            };

            request.onerror = () => {
                showAlert('Error creating reconciliation', 'error');
            };
        }

        function viewReconciliation(id) {
            showAlert('Detailed reconciliation view coming soon!', 'error');
        }

        function deleteReconciliation(id) {
            if (!confirm('Are you sure you want to delete this reconciliation?')) return;

            const transaction = db.transaction(['bankReconciliations'], 'readwrite');
            const reconStore = transaction.objectStore('bankReconciliations');
            const request = reconStore.delete(id);

            request.onsuccess = () => {
                showAlert('Reconciliation deleted successfully!', 'success');
                loadBankReconciliationPage();
            };
        }

        // REPORTS MODULE
        function loadReportsPage() {
            if (!currentSocietyId) {
                document.getElementById('contentArea').innerHTML = '<p>Please select a society first</p>';
                return;
            }

            document.getElementById('contentArea').innerHTML = `
                <h3>Financial Reports</h3>
                <p style="margin-bottom: 30px;">Select a report to view</p>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div class="stat-card" onclick="generateBalanceSheet(); event.stopPropagation();" style="cursor: pointer;">
                        <h3>üìä</h3>
                        <p>Balance Sheet</p>
                    </div>
                    <div class="stat-card" onclick="generateProfitLoss(); event.stopPropagation();" style="cursor: pointer;">
                        <h3>üìà</h3>
                        <p>Profit & Loss</p>
                    </div>
                    <div class="stat-card" onclick="generateTrialBalance(); event.stopPropagation();" style="cursor: pointer;">
                        <h3>‚öñÔ∏è</h3>
                        <p>Trial Balance</p>
                    </div>
                    <div class="stat-card" onclick="generateLedger(); event.stopPropagation();" style="cursor: pointer;">
                        <h3>üìñ</h3>
                        <p>Ledger Report</p>
                    </div>
                </div>
            `;
        }

        function generateBalanceSheet() {
            showAlert('Generating Balance Sheet...', 'success');
            // Implementation from Phase 3
        }

        function generateProfitLoss() {
            showAlert('Generating Profit & Loss Statement...', 'success');
            // Implementation from Phase 3
        }

        function generateTrialBalance() {
            showAlert('Generating Trial Balance...', 'success');
            // Implementation from Phase 3
        }

        function generateLedger() {
            showAlert('Ledger report - Select account first', 'error');
        }

        // BACKUP MODULE
        function loadBackupPage() {
            document.getElementById('contentArea').innerHTML = `
                <h3>Backup & Export Data</h3>
                <p style="margin-bottom: 30px;">Export your data for backup or migration purposes</p>

                <div class="stats-grid">
                    <div class="stat-card" onclick="exportAllData(); event.stopPropagation();" style="cursor: pointer;">
                        <h3>üíæ</h3>
                        <p>Export All Data (JSON)</p>
                    </div>
                    <div class="stat-card" onclick="exportMembers(); event.stopPropagation();" style="cursor: pointer;">
                        <h3>üë•</h3>
                        <p>Export Members (CSV)</p>
                    </div>
                    <div class="stat-card" onclick="exportAccounts(); event.stopPropagation();" style="cursor: pointer;">
                        <h3>üìñ</h3>
                        <p>Export Accounts (CSV)</p>
                    </div>
                    <div class="stat-card" onclick="exportEntries(); event.stopPropagation();" style="cursor: pointer;">
                        <h3>üìù</h3>
                        <p>Export Entries (CSV)</p>
                    </div>
                </div>
            `;
        }

        function exportAllData() {
            showAlert('Exporting all data...', 'success');
            // Implementation from Phase 3
        }

        function exportMembers() {
            if (!currentSocietyId) {
                showAlert('Please select a society first', 'error');
                return;
            }

            const transaction = db.transaction(['members'], 'readonly');
            const memberStore = transaction.objectStore('members');
            const index = memberStore.index('societyId');
            const request = index.getAll(currentSocietyId);

            request.onsuccess = () => {
                const members = request.result;
                
                let csv = 'Flat No,Member Name,Mobile,Email,Area,Share Amount,Opening Balance,Status\n';
                
                members.forEach(m => {
                    csv += `"${m.flatNo}","${m.name}","${m.mobile}","${m.email || ''}","${m.area || ''}","${m.shareAmount || ''}","${m.openingBalance || ''}","${m.status}"\n`;
                });
                
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `members-${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                
                showAlert('Members exported successfully!', 'success');
            };
        }

        function exportAccounts() {
            showAlert('Exporting accounts...', 'success');
            // Similar to exportMembers
        }

        function exportEntries() {
            showAlert('Exporting entries...', 'success');
            // Similar to exportMembers
        }

        // Society Management Functions
        function loadSocietiesIntoDropdown() {
            const transaction = db.transaction(['societies'], 'readonly');
            const objectStore = transaction.objectStore('societies');
            const request = objectStore.getAll();

            request.onsuccess = () => {
                const societies = request.result;
                const select = document.getElementById('sidebarSocietySelect');
                
                select.innerHTML = '<option value="">Select Society</option>';
                societies.forEach(society => {
                    const option = document.createElement('option');
                    option.value = society.id;
                    option.textContent = society.name;
                    select.appendChild(option);
                });

                if (currentSocietyId) {
                    select.value = currentSocietyId;
                }
            };
        }

        function changeSociety() {
            const select = document.getElementById('sidebarSocietySelect');
            currentSocietyId = select.value ? parseInt(select.value) : null;
            
            if (currentSocietyId) {
                localStorage.setItem('selectedSocietyId', currentSocietyId);
                
                const transaction = db.transaction(['societies'], 'readonly');
                const objectStore = transaction.objectStore('societies');
                const request = objectStore.get(currentSocietyId);
                
                request.onsuccess = () => {
                    const society = request.result;
                    document.getElementById('currentSocietyName').textContent = society.name;
                    showAlert(`Society changed to: ${society.name}`, 'success');
                    loadDashboard();
                };
            } else {
                localStorage.removeItem('selectedSocietyId');
                document.getElementById('currentSocietyName').textContent = '';
                loadDashboard();
            }
        }

        function selectSocietyDirect(id) {
            currentSocietyId = id;
            localStorage.setItem('selectedSocietyId', id);
            document.getElementById('sidebarSocietySelect').value = id;
            
            const transaction = db.transaction(['societies'], 'readonly');
            const objectStore = transaction.objectStore('societies');
            const request = objectStore.get(id);
            
            request.onsuccess = () => {
                const society = request.result;
                document.getElementById('currentSocietyName').textContent = society.name;
                showAlert(`Society selected: ${society.name}`, 'success');
                navigateTo('dashboard');
            };
        }

        function checkSelectedSociety() {
            const savedSocietyId = localStorage.getItem('selectedSocietyId');
            if (savedSocietyId) {
                currentSocietyId = parseInt(savedSocietyId);
                document.getElementById('sidebarSocietySelect').value = currentSocietyId;
                
                const transaction = db.transaction(['societies'], 'readonly');
                const objectStore = transaction.objectStore('societies');
                const request = objectStore.get(currentSocietyId);
                
                request.onsuccess = () => {
                    if (request.result) {
                        document.getElementById('currentSocietyName').textContent = request.result.name;
                    }
                };
            }
            loadDashboard();
        }

        // Utility Functions
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showAlert(message, type) {
            const alertBox = document.getElementById('alertBox');
            alertBox.className = `alert alert-${type} show`;
            alertBox.textContent = message;
            
            setTimeout(() => {
                alertBox.classList.remove('show');
            }, 5000);
        }

        // Initialize
        window.onload = () => {
            initDB();
        };
    </script>
</body>
</html>
