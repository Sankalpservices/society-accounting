<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Society Accounting Software - Sankalp Management</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; }
        .sidebar { position: fixed; left: 0; top: 0; width: 260px; height: 100vh; background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%); color: white; z-index: 1000; overflow-y: auto; }
        .sidebar-header { padding: 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sidebar-header h2 { font-size: 1.3em; margin-bottom: 5px; }
        .society-selector { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .society-selector select { width: 100%; padding: 10px; border: none; border-radius: 5px; background: rgba(255,255,255,0.1); color: white; cursor: pointer; }
        .society-selector select option { background: #2c3e50; color: white; }
        .sidebar-menu { padding: 20px 0; }
        .menu-item { padding: 15px 20px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 15px; color: rgba(255,255,255,0.8); }
        .menu-item:hover { background: rgba(255,255,255,0.1); color: white; }
        .menu-item.active { background: rgba(102, 126, 234, 0.3); border-left: 4px solid #667eea; color: white; }
        .main-content { margin-left: 260px; padding: 30px; min-height: 100vh; }
        .top-bar { background: white; padding: 20px 30px; border-radius: 10px; margin-bottom: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .top-bar h1 { color: #2c3e50; font-size: 1.8em; }
        .content-area { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); min-height: 500px; }
        .btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 24px; font-size: 14px; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; margin: 5px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .btn-sm { padding: 8px 16px; font-size: 12px; }
        .btn-success { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .btn-danger { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); cursor: pointer; }
        .stat-card h3 { font-size: 2.5em; margin-bottom: 10px; }
        .stat-card p { opacity: 0.9; font-size: 1.1em; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 600; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .data-table th, .data-table td { padding: 12px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        .data-table th { background: #f8f9fa; color: #2c3e50; font-weight: 600; }
        .data-table tr:hover { background: #f8f9fa; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; overflow-y: auto; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 10px; max-width: 1000px; width: 95%; max-height: 95vh; overflow-y: auto; position: relative; margin: 20px; }
        .modal-close { position: absolute; top: 15px; right: 20px; font-size: 28px; cursor: pointer; color: #999; }
        .modal-close:hover { color: #f5576c; }
        .alert { padding: 15px 20px; border-radius: 6px; margin-bottom: 20px; display: none; }
        .alert.show { display: block; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .billing-head-row { display: grid; grid-template-columns: 2fr 1.5fr 1.5fr 0.5fr; gap: 10px; margin-bottom: 10px; align-items: end; }
        .file-upload-area { border: 2px dashed #667eea; padding: 40px; text-align: center; border-radius: 10px; margin: 20px 0; cursor: pointer; }
        .file-upload-area:hover { background: #f8f9fa; }
        .invoice-preview { border: 2px solid #e0e0e0; padding: 40px; background: white; margin: 20px 0; }
        .invoice-header { text-align: center; border-bottom: 3px solid #667eea; padding-bottom: 20px; margin-bottom: 30px; }
        .invoice-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .invoice-table th, .invoice-table td { border: 1px solid #ddd; padding: 12px; }
        .invoice-table th { background: #667eea; color: white; }
        @media print { .sidebar, .top-bar, .btn, .no-print { display: none !important; } .main-content { margin-left: 0; } }
    </style>
</head>
<body>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header"><h2>üè¢ Sankalp</h2><p>Society Accounting</p></div>
        <div class="society-selector">
            <select id="sidebarSocietySelect" onchange="changeSociety()"><option value="">Select Society</option></select>
        </div>
        <div class="sidebar-menu">
            <div class="menu-item active" data-page="dashboard"><i>üìä</i><span>Dashboard</span></div>
            <div class="menu-item" data-page="societies"><i>üèòÔ∏è</i><span>Societies</span></div>
            <div class="menu-item" data-page="members"><i>üë•</i><span>Members</span></div>
            <div class="menu-item" data-page="accounts"><i>üìñ</i><span>Chart of Accounts</span></div>
            <div class="menu-item" data-page="billing"><i>üí∞</i><span>Billing</span></div>
            <div class="menu-item" data-page="entries"><i>üìù</i><span>Entries</span></div>
            <div class="menu-item" data-page="reports"><i>üìà</i><span>Reports</span></div>
            <div class="menu-item" data-page="backup"><i>üíæ</i><span>Backup</span></div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="top-bar">
            <h1 id="pageTitle">Dashboard</h1>
            <div><span id="currentSocietyName" style="color: #667eea; font-weight: 600;"></span></div>
        </div>
        <div id="alertBox" class="alert"></div>
        <div class="content-area" id="contentArea"></div>
    </div>

    <!-- Modals -->
    <div id="societyModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('societyModal')">&times;</span>
            <h2>Add New Society</h2>
            <form id="societyForm" onsubmit="saveSociety(event)">
                <div class="form-grid">
                    <div class="form-group"><label>Society Name *</label><input type="text" id="societyName" required></div>
                    <div class="form-group"><label>Registration Number *</label><input type="text" id="regNumber" required></div>
                    <div class="form-group"><label>City</label><input type="text" id="city"></div>
                </div>
                <button type="submit" class="btn btn-success">Save Society</button>
                <button type="button" class="btn" onclick="closeModal('societyModal')">Cancel</button>
            </form>
        </div>
    </div>

    <div id="memberModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('memberModal')">&times;</span>
            <h2>Add Member</h2>
            <form id="memberForm" onsubmit="saveMember(event)">
                <input type="hidden" id="memberId">
                <div class="form-grid">
                    <div class="form-group"><label>Member Name *</label><input type="text" id="memberName" required></div>
                    <div class="form-group"><label>Flat No *</label><input type="text" id="flatNo" required></div>
                    <div class="form-group"><label>Mobile *</label><input type="tel" id="memberMobile" pattern="[0-9]{10}" required></div>
                    <div class="form-group"><label>Area (Sq.Ft.)</label><input type="number" id="area" step="0.01"></div>
                    <div class="form-group"><label>Opening Balance</label><input type="number" id="memberOpeningBalance" step="0.01" value="0"></div>
                    <div class="form-group"><label>Status</label><select id="memberStatus"><option value="active">Active</option><option value="inactive">Inactive</option></select></div>
                </div>
                <button type="submit" class="btn btn-success">Save Member</button>
                <button type="button" class="btn" onclick="closeModal('memberModal')">Cancel</button>
            </form>
        </div>
    </div>

    <div id="importMembersModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('importMembersModal')">&times;</span>
            <h2>Import Members from CSV/Excel</h2>
            <div class="file-upload-area" id="fileUploadArea" onclick="document.getElementById('fileInput').click()">
                <h3>üìÅ Click to Upload CSV/Excel File</h3>
                <p>Or drag and drop file here</p>
                <p style="margin-top: 10px; font-size: 12px; color: #666;">Required columns: Flat No, Member Name, Mobile, Area</p>
            </div>
            <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;" onchange="handleFileUpload(event)">
            <div id="importPreview"></div>
            <button class="btn btn-success" id="confirmImport" style="display: none;" onclick="confirmMemberImport()">Confirm Import</button>
            <button class="btn" onclick="closeModal('importMembersModal')">Cancel</button>
        </div>
    </div>

    <div id="accountModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('accountModal')">&times;</span>
            <h2>Add Account</h2>
            <form id="accountForm" onsubmit="saveAccount(event)">
                <div class="form-group"><label>Account Group *</label><select id="accountGroup" required onchange="updateSubGroups()"><option value="">Select Group</option><option value="Assets">Assets</option><option value="Liabilities">Liabilities</option><option value="Income">Income</option><option value="Expenses">Expenses</option></select></div>
                <div class="form-group"><label>Sub Group *</label><select id="accountSubGroup" required><option value="">Select Sub Group</option></select></div>
                <div class="form-group"><label>Account Head Name *</label><input type="text" id="accountName" required></div>
                <div class="form-group"><label>Opening Balance</label><input type="number" id="accountOpeningBalance" step="0.01" value="0"></div>
                <button type="submit" class="btn btn-success">Save Account</button>
                <button type="button" class="btn" onclick="closeModal('accountModal')">Cancel</button>
            </form>
        </div>
    </div>

    <div id="billingModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('billingModal')">&times;</span>
            <h2>Generate Member Bills</h2>
            <form id="billingForm" onsubmit="generateBills(event)">
                <div class="form-grid">
                    <div class="form-group"><label>Billing Period From *</label><input type="month" id="billingPeriodFrom" required></div>
                    <div class="form-group"><label>Billing Period To *</label><input type="month" id="billingPeriodTo" required></div>
                    <div class="form-group"><label>Billing Date *</label><input type="date" id="billingDate" required></div>
                    <div class="form-group"><label>GST % (Optional)</label><input type="number" id="gstPercent" step="0.01" value="0" placeholder="0"></div>
                </div>
                <h4 style="margin: 20px 0;">Billing Heads</h4>
                <div id="billingHeadsContainer"></div>
                <button type="button" class="btn btn-sm" onclick="addBillingHead()">+ Add Billing Head</button>
                <div style="margin-top: 20px;">
                    <button type="submit" class="btn btn-success">Generate Bills</button>
                    <button type="button" class="btn" onclick="closeModal('billingModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="billViewModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="modal-close" onclick="closeModal('billViewModal')">&times;</span>
            <div class="no-print" style="margin-bottom: 20px;">
                <button class="btn btn-success" onclick="downloadBillPDF()">Download PDF</button>
                <button class="btn" onclick="window.print()">Print</button>
            </div>
            <div id="billPreviewContent"></div>
        </div>
    </div>

    <div id="memberLedgerModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('memberLedgerModal')">&times;</span>
            <h2 id="ledgerMemberName">Member Ledger</h2>
            <div id="memberLedgerContent"></div>
        </div>
    </div>

    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('paymentModal')">&times;</span>
            <h2>Record Payment</h2>
            <form id="paymentForm" onsubmit="savePayment(event)">
                <input type="hidden" id="paymentBillId">
                <input type="hidden" id="paymentMemberId">
                <div class="form-grid">
                    <div class="form-group"><label>Payment Date *</label><input type="date" id="paymentDate" required></div>
                    <div class="form-group"><label>Amount *</label><input type="number" id="paymentAmount" step="0.01" required></div>
                    <div class="form-group"><label>Payment Mode *</label><select id="paymentMode"><option value="cash">Cash</option><option value="cheque">Cheque</option><option value="online">Online Transfer</option><option value="upi">UPI</option></select></div>
                    <div class="form-group"><label>Reference/Transaction No</label><input type="text" id="paymentRef"></div>
                </div>
                <button type="submit" class="btn btn-success">Save Payment</button>
                <button type="button" class="btn" onclick="closeModal('paymentModal')">Cancel</button>
            </form>
        </div>
    </div>

    <div id="entryModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('entryModal')">&times;</span>
            <h2>New Entry</h2>
            <form id="entryForm" onsubmit="saveEntry(event)">
                <div class="form-grid">
                    <div class="form-group"><label>Entry Type *</label><select id="entryType" required><option value="receipt">Receipt</option><option value="payment">Payment</option><option value="journal">Journal</option></select></div>
                    <div class="form-group"><label>Entry Date *</label><input type="date" id="entryDate" required></div>
                    <div class="form-group"><label>Debit Account *</label><select id="debitAccount" required><option value="">Select</option></select></div>
                    <div class="form-group"><label>Credit Account *</label><select id="creditAccount" required><option value="">Select</option></select></div>
                    <div class="form-group"><label>Amount *</label><input type="number" id="entryAmount" step="0.01" required></div>
                    <div class="form-group"><label>TDS % (if applicable)</label><input type="number" id="tdsPercent" step="0.01" value="0" onchange="calculateTDS()"></div>
                    <div class="form-group"><label>TDS Amount</label><input type="number" id="tdsAmount" step="0.01" value="0" readonly></div>
                    <div class="form-group"><label>Net Amount</label><input type="number" id="netAmount" step="0.01" readonly></div>
                    <div class="form-group"><label>Description</label><input type="text" id="entryDescription"></div>
                </div>
                <button type="submit" class="btn btn-success">Save Entry</button>
                <button type="button" class="btn" onclick="closeModal('entryModal')">Cancel</button>
            </form>
        </div>
    </div>

    <script>
        const DB_NAME = 'SocietyAccountingDB'; const DB_VERSION = 7;
        let db; let currentSocietyId = null; let importedMembers = [];

        const accountSubGroups = {
            'Assets': ['Current Assets', 'Fixed Assets', 'Investments'],
            'Liabilities': ['Current Liabilities', 'Long-term Liabilities', 'Capital & Reserves'],
            'Income': ['Member Contributions', 'Other Income', 'Interest Income'],
            'Expenses': ['Operating Expenses', 'Maintenance Expenses', 'Administrative Expenses']
        };

        function initDB() {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onerror = (e) => showAlert('Database error: ' + e.target.error, 'error');
            request.onsuccess = (e) => {
                db = e.target.result;
                loadSocietiesIntoDropdown();
                checkSelectedSociety();
                setupMenuListeners();
            };
            request.onupgradeneeded = (e) => {
                db = e.target.result;
                if (!db.objectStoreNames.contains('societies')) {
                    const s = db.createObjectStore('societies', { keyPath: 'id', autoIncrement: true });
                    s.createIndex('name', 'name', { unique: false });
                }
                if (!db.objectStoreNames.contains('members')) {
                    const m = db.createObjectStore('members', { keyPath: 'id', autoIncrement: true });
                    m.createIndex('societyId', 'societyId', { unique: false });
                }
                if (!db.objectStoreNames.contains('accounts')) {
                    const a = db.createObjectStore('accounts', { keyPath: 'id', autoIncrement: true });
                    a.createIndex('societyId', 'societyId', { unique: false });
                }
                if (!db.objectStoreNames.contains('bills')) {
                    const b = db.createObjectStore('bills', { keyPath: 'id', autoIncrement: true });
                    b.createIndex('societyId', 'societyId', { unique: false });
                    b.createIndex('memberId', 'memberId', { unique: false });
                }
                if (!db.objectStoreNames.contains('payments')) {
                    const p = db.createObjectStore('payments', { keyPath: 'id', autoIncrement: true });
                    p.createIndex('societyId', 'societyId', { unique: false });
                    p.createIndex('memberId', 'memberId', { unique: false });
                }
                if (!db.objectStoreNames.contains('entries')) {
                    const en = db.createObjectStore('entries', { keyPath: 'id', autoIncrement: true });
                    en.createIndex('societyId', 'societyId', { unique: false });
                }
            };
        }

        function setupMenuListeners() {
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', function() {
                    navigateTo(this.getAttribute('data-page'));
                });
            });
        }

        function navigateTo(page) {
            document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
            const active = document.querySelector(`.menu-item[data-page="${page}"]`);
            if (active) active.classList.add('active');
            const titles = {'dashboard':'Dashboard','societies':'Manage Societies','members':'Member Management','accounts':'Chart of Accounts','billing':'Billing','entries':'Entries','reports':'Reports','backup':'Backup'};
            document.getElementById('pageTitle').textContent = titles[page] || page;
            loadPageContent(page);
        }

        function loadPageContent(page) {
            switch(page) {
                case 'dashboard': loadDashboard(); break;
                case 'societies': loadSocietiesPage(); break;
                case 'members': loadMembersPage(); break;
                case 'accounts': loadAccountsPage(); break;
                case 'billing': loadBillingPage(); break;
                case 'entries': loadEntriesPage(); break;
                case 'reports': loadReportsPage(); break;
                case 'backup': loadBackupPage(); break;
                default: loadDashboard();
            }
        }

        function loadDashboard() {
            if (!currentSocietyId) {
                document.getElementById('contentArea').innerHTML = '<div style="text-align:center;padding:60px;"><h2>No Society Selected</h2><p>Please select a society</p><button class="btn btn-success" onclick="navigateTo(\'societies\')">Manage Societies</button></div>';
                return;
            }
            document.getElementById('contentArea').innerHTML = '<div class="stats-grid"><div class="stat-card"><h3>0</h3><p>Members</p></div><div class="stat-card"><h3>0</h3><p>Bills</p></div><div class="stat-card"><h3>‚Çπ0</h3><p>Collections</p></div><div class="stat-card"><h3>‚Çπ0</h3><p>Outstanding</p></div></div><h3>Quick Actions</h3><div style="margin-top:20px;"><button class="btn btn-success" onclick="navigateTo(\'members\')">Add Member</button><button class="btn" onclick="navigateTo(\'billing\')">Generate Bills</button><button class="btn" onclick="navigateTo(\'reports\')">View Reports</button></div>';
        }

        function loadSocietiesPage() {
            const t = db.transaction(['societies'], 'readonly');
            const r = t.objectStore('societies').getAll();
            r.onsuccess = () => {
                const s = r.result;
                document.getElementById('contentArea').innerHTML = `
                    <div style="margin-bottom:20px;"><button class="btn btn-success" onclick="document.getElementById('societyModal').classList.add('active')">+ Add Society</button></div>
                    <table class="data-table"><thead><tr><th>Name</th><th>Reg No</th><th>City</th><th>Actions</th></tr></thead>
                    <tbody>${s.map(x=>`<tr><td>${x.name}</td><td>${x.regNumber}</td><td>${x.city||'N/A'}</td><td><button class="btn btn-sm btn-success" onclick="selectSocietyDirect(${x.id})">Select</button></td></tr>`).join('')||'<tr><td colspan="4" style="text-align:center;">No societies</td></tr>'}</tbody></table>
                `;
            };
        }

        function saveSociety(e) {
            e.preventDefault();
            const soc = {name:document.getElementById('societyName').value,regNumber:document.getElementById('regNumber').value,city:document.getElementById('city').value,createdDate:new Date().toISOString()};
            const t = db.transaction(['societies'], 'readwrite');
            t.objectStore('societies').add(soc).onsuccess = () => {
                showAlert('Society added!','success');
                closeModal('societyModal');
                loadSocietiesIntoDropdown();
                loadSocietiesPage();
            };
        }

        function loadMembersPage() {
            if (!currentSocietyId) return;
            const t = db.transaction(['members'], 'readonly');
            const r = t.objectStore('members').index('societyId').getAll(currentSocietyId);
            r.onsuccess = () => {
                const m = r.result;
                document.getElementById('contentArea').innerHTML = `
                    <div style="margin-bottom:20px;">
                        <button class="btn btn-success" onclick="document.getElementById('memberModal').classList.add('active')">+ Add Member</button>
                        <button class="btn" onclick="document.getElementById('importMembersModal').classList.add('active')">üìÅ Import CSV/Excel</button>
                    </div>
                    <table class="data-table"><thead><tr><th>Flat</th><th>Name</th><th>Mobile</th><th>Area</th><th>Opening Bal</th><th>Actions</th></tr></thead>
                    <tbody>${m.map(x=>`<tr><td>${x.flatNo}</td><td>${x.name}</td><td>${x.mobile}</td><td>${x.area||0}</td><td>‚Çπ${x.openingBalance||0}</td><td><button class="btn btn-sm" onclick="viewMemberLedger(${x.id})">Ledger</button></td></tr>`).join('')||'<tr><td colspan="6" style="text-align:center;">No members</td></tr>'}</tbody></table>
                `;
            };
        }

        function saveMember(e) {
            e.preventDefault();
            const mem = {societyId:currentSocietyId,name:document.getElementById('memberName').value,flatNo:document.getElementById('flatNo').value,mobile:document.getElementById('memberMobile').value,area:parseFloat(document.getElementById('area').value)||0,openingBalance:parseFloat(document.getElementById('memberOpeningBalance').value)||0,status:document.getElementById('memberStatus').value,createdDate:new Date().toISOString()};
            db.transaction(['members'],'readwrite').objectStore('members').add(mem).onsuccess = () => {
                showAlert('Member added!','success');
                closeModal('memberModal');
                loadMembersPage();
            };
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const data = new Uint8Array(ev.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet);
                importedMembers = json.map(row => ({
                    flatNo: row['Flat No'] || row['flatNo'] || row['Flat'],
                    name: row['Member Name'] || row['Name'] || row['name'],
                    mobile: row['Mobile'] || row['mobile'] || row['Phone'],
                    area: parseFloat(row['Area'] || row['area']) || 0,
                    openingBalance: parseFloat(row['Opening Balance'] || row['openingBalance']) || 0
                }));
                document.getElementById('importPreview').innerHTML = `<p><strong>${importedMembers.length} members ready to import</strong></p>`;
                document.getElementById('confirmImport').style.display = 'inline-block';
            };
            reader.readAsArrayBuffer(file);
        }

        function confirmMemberImport() {
            const t = db.transaction(['members'], 'readwrite');
            const store = t.objectStore('members');
            let count = 0;
            importedMembers.forEach(m => {
                m.societyId = currentSocietyId;
                m.status = 'active';
                m.createdDate = new Date().toISOString();
                store.add(m).onsuccess = () => {
                    count++;
                    if (count === importedMembers.length) {
                        showAlert(`${count} members imported!`, 'success');
                        closeModal('importMembersModal');
                        loadMembersPage();
                    }
                };
            });
        }

        function loadAccountsPage() {
            if (!currentSocietyId) return;
            const t = db.transaction(['accounts'], 'readonly');
            const r = t.objectStore('accounts').index('societyId').getAll(currentSocietyId);
            r.onsuccess = () => {
                const a = r.result;
                document.getElementById('contentArea').innerHTML = `
                    <div style="margin-bottom:20px;">
                        <button class="btn btn-success" onclick="document.getElementById('accountModal').classList.add('active')">+ Add Account</button>
                        <button class="btn" onclick="addStandardAccounts()">Add Standard Heads</button>
                    </div>
                    <table class="data-table"><thead><tr><th>Group</th><th>Sub Group</th><th>Account Head</th><th>Balance</th></tr></thead>
                    <tbody>${a.map(x=>`<tr><td>${x.group}</td><td>${x.subGroup}</td><td>${x.name}</td><td>‚Çπ${x.openingBalance||0}</td></tr>`).join('')||'<tr><td colspan="4" style="text-align:center;">No accounts</td></tr>'}</tbody></table>
                `;
            };
        }

        function updateSubGroups() {
            const group = document.getElementById('accountGroup').value;
            const sub = document.getElementById('accountSubGroup');
            sub.innerHTML = '<option value="">Select Sub Group</option>';
            if (group && accountSubGroups[group]) {
                accountSubGroups[group].forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s;
                    opt.textContent = s;
                    sub.appendChild(opt);
                });
            }
        }

        function saveAccount(e) {
            e.preventDefault();
            const acc = {societyId:currentSocietyId,group:document.getElementById('accountGroup').value,subGroup:document.getElementById('accountSubGroup').value,name:document.getElementById('accountName').value,openingBalance:parseFloat(document.getElementById('accountOpeningBalance').value)||0,createdDate:new Date().toISOString()};
            db.transaction(['accounts'],'readwrite').objectStore('accounts').add(acc).onsuccess = () => {
                showAlert('Account added!','success');
                closeModal('accountModal');
                loadAccountsPage();
            };
        }

        function addStandardAccounts() {
            const std = [
                {group:'Assets',subGroup:'Current Assets',name:'Cash in Hand',openingBalance:0},
                {group:'Assets',subGroup:'Current Assets',name:'Bank - SBI',openingBalance:0},
                {group:'Assets',subGroup:'Current Assets',name:'Members Outstanding',openingBalance:0},
                {group:'Liabilities',subGroup:'Current Liabilities',name:'Sundry Creditors',openingBalance:0},
                {group:'Liabilities',subGroup:'Capital & Reserves',name:'Corpus Fund',openingBalance:0},
                {group:'Income',subGroup:'Member Contributions',name:'Maintenance Charges',openingBalance:0},
                {group:'Income',subGroup:'Member Contributions',name:'Water Charges',openingBalance:0},
                {group:'Expenses',subGroup:'Operating Expenses',name:'Electricity',openingBalance:0},
                {group:'Expenses',subGroup:'Operating Expenses',name:'Staff Salaries',openingBalance:0}
            ];
            const t = db.transaction(['accounts'],'readwrite');
            let count = 0;
            std.forEach(a => {
                a.societyId = currentSocietyId;
                a.createdDate = new Date().toISOString();
                t.objectStore('accounts').add(a).onsuccess = () => {
                    count++;
                    if (count === std.length) {
                        showAlert('Standard accounts added!','success');
                        loadAccountsPage();
                    }
                };
            });
        }

        function loadBillingPage() {
            if (!currentSocietyId) return;
            const t = db.transaction(['bills'], 'readonly');
            const r = t.objectStore('bills').index('societyId').getAll(currentSocietyId);
            r.onsuccess = () => {
                const b = r.result;
                document.getElementById('contentArea').innerHTML = `
                    <div style="margin-bottom:20px;"><button class="btn btn-success" onclick="openBillingModal()">Generate Bills</button></div>
                    <table class="data-table"><thead><tr><th>Member</th><th>Period</th><th>Amount</th><th>GST</th><th>Total</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody>${b.map(x=>`<tr><td>${x.memberName}</td><td>${x.periodFrom} to ${x.periodTo}</td><td>‚Çπ${x.subtotal.toFixed(2)}</td><td>‚Çπ${(x.gst||0).toFixed(2)}</td><td>‚Çπ${x.totalAmount.toFixed(2)}</td><td>${x.status}</td><td><button class="btn btn-sm" onclick="viewBill(${x.id})">View</button> <button class="btn btn-sm btn-success" onclick="openPaymentModal(${x.id},${x.memberId})">Pay</button></td></tr>`).join('')||'<tr><td colspan="7" style="text-align:center;">No bills</td></tr>'}</tbody></table>
                `;
            };
        }

        function openBillingModal() {
            const today = new Date();
            document.getElementById('billingPeriodFrom').value = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
            document.getElementById('billingPeriodTo').value = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
            document.getElementById('billingDate').value = today.toISOString().split('T')[0];
            document.getElementById('billingHeadsContainer').innerHTML = '';
            addBillingHead();
            addBillingHead();
            document.getElementById('billingModal').classList.add('active');
        }

        let billingHeadCounter = 0;
        function addBillingHead() {
            const container = document.getElementById('billingHeadsContainer');
            const row = document.createElement('div');
            row.className = 'billing-head-row';
            row.innerHTML = `
                <div class="form-group" style="margin:0;"><input type="text" class="billing-head-name" placeholder="Head Name" required></div>
                <div class="form-group" style="margin:0;"><select class="billing-calc-type"><option value="fixed">Fixed Amount</option><option value="perarea">Per Sq.Ft.</option><option value="member">Member Specific</option></select></div>
                <div class="form-group" style="margin:0;"><input type="number" class="billing-head-rate" step="0.01" placeholder="Rate/Amount" required></div>
                <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">√ó</button>
            `;
            container.appendChild(row);
        }

        function generateBills(e) {
            e.preventDefault();
            const periodFrom = document.getElementById('billingPeriodFrom').value;
            const periodTo = document.getElementById('billingPeriodTo').value;
            const billingDate = document.getElementById('billingDate').value;
            const gstPercent = parseFloat(document.getElementById('gstPercent').value) || 0;
            
            const heads = [];
            document.querySelectorAll('.billing-head-row').forEach(row => {
                const name = row.querySelector('.billing-head-name').value;
                const type = row.querySelector('.billing-calc-type').value;
                const rate = parseFloat(row.querySelector('.billing-head-rate').value);
                if (name && rate) heads.push({name, type, rate});
            });

            const t = db.transaction(['members','bills'], 'readwrite');
            const memStore = t.objectStore('members');
            const billStore = t.objectStore('bills');
            memStore.index('societyId').getAll(currentSocietyId).onsuccess = (ev) => {
                const members = ev.target.result.filter(m => m.status === 'active');
                let count = 0;
                members.forEach(member => {
                    let subtotal = 0;
                    const charges = {};
                    heads.forEach(h => {
                        let amt = 0;
                        if (h.type === 'fixed') amt = h.rate;
                        else if (h.type === 'perarea') amt = (member.area || 0) * h.rate;
                        else amt = h.rate;
                        charges[h.name] = amt;
                        subtotal += amt;
                    });
                    const gst = subtotal * (gstPercent / 100);
                    const total = subtotal + gst;
                    const bill = {societyId:currentSocietyId,memberId:member.id,memberName:member.name,flatNo:member.flatNo,periodFrom,periodTo,billingDate,charges,subtotal,gst,gstPercent,totalAmount:total,status:'pending',createdDate:new Date().toISOString()};
                    billStore.add(bill).onsuccess = () => {
                        count++;
                        if (count === members.length) {
                            showAlert(`${count} bills generated!`,'success');
                            closeModal('billingModal');
                            loadBillingPage();
                        }
                    };
                });
            };
        }

        function viewBill(billId) {
            const t = db.transaction(['bills'], 'readonly');
            t.objectStore('bills').get(billId).onsuccess = (e) => {
                const bill = e.target.result;
                const chargesHTML = Object.entries(bill.charges).map(([k,v]) => `<tr><td>${k}</td><td style="text-align:right;">‚Çπ${v.toFixed(2)}</td></tr>`).join('');
                document.getElementById('billPreviewContent').innerHTML = `
                    <div class="invoice-preview">
                        <div class="invoice-header"><h2>TAX INVOICE</h2><p>Society Maintenance Bill</p></div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:30px;">
                            <div><strong>To:</strong><br>${bill.memberName}<br>Flat No: ${bill.flatNo}</div>
                            <div style="text-align:right;"><strong>Bill No:</strong> ${bill.id}<br><strong>Date:</strong> ${bill.billingDate}<br><strong>Period:</strong> ${bill.periodFrom} to ${bill.periodTo}</div>
                        </div>
                        <table class="invoice-table"><thead><tr><th>Particulars</th><th style="text-align:right;">Amount</th></tr></thead>
                        <tbody>${chargesHTML}
                        <tr><td><strong>Subtotal</strong></td><td style="text-align:right;"><strong>‚Çπ${bill.subtotal.toFixed(2)}</strong></td></tr>
                        ${bill.gst > 0 ? `<tr><td>GST @ ${bill.gstPercent}%</td><td style="text-align:right;">‚Çπ${bill.gst.toFixed(2)}</td></tr>` : ''}
                        <tr style="font-size:18px;"><td><strong>Total Amount</strong></td><td style="text-align:right;"><strong>‚Çπ${bill.totalAmount.toFixed(2)}</strong></td></tr>
                        </tbody></table>
                    </div>
                `;
                document.getElementById('billViewModal').classList.add('active');
            };
        }

        function downloadBillPDF() {
            const element = document.getElementById('billPreviewContent');
            html2pdf().from(element).save('bill.pdf');
        }

        function openPaymentModal(billId, memberId) {
            document.getElementById('paymentBillId').value = billId;
            document.getElementById('paymentMemberId').value = memberId;
            document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
            
            const t = db.transaction(['bills'], 'readonly');
            t.objectStore('bills').get(billId).onsuccess = (e) => {
                document.getElementById('paymentAmount').value = e.target.result.totalAmount;
            };
            document.getElementById('paymentModal').classList.add('active');
        }

        function savePayment(e) {
            e.preventDefault();
            const billId = parseInt(document.getElementById('paymentBillId').value);
            const memberId = parseInt(document.getElementById('paymentMemberId').value);
            const payment = {societyId:currentSocietyId,billId,memberId,date:document.getElementById('paymentDate').value,amount:parseFloat(document.getElementById('paymentAmount').value),mode:document.getElementById('paymentMode').value,reference:document.getElementById('paymentRef').value,createdDate:new Date().toISOString()};
            
            const t = db.transaction(['payments','bills'], 'readwrite');
            t.objectStore('payments').add(payment);
            const billReq = t.objectStore('bills').get(billId);
            billReq.onsuccess = () => {
                const bill = billReq.result;
                bill.status = 'paid';
                t.objectStore('bills').put(bill);
                showAlert('Payment recorded!','success');
                closeModal('paymentModal');
                loadBillingPage();
            };
        }

        function viewMemberLedger(memberId) {
            const t = db.transaction(['members','bills','payments'], 'readonly');
            t.objectStore('members').get(memberId).onsuccess = (e) => {
                const member = e.target.result;
                document.getElementById('ledgerMemberName').textContent = `${member.name} - Flat ${member.flatNo}`;
                
                const billsReq = t.objectStore('bills').index('memberId').getAll(memberId);
                const paymentsReq = t.objectStore('payments').index('memberId').getAll(memberId);
                
                Promise.all([
                    new Promise(r => billsReq.onsuccess = () => r(billsReq.result)),
                    new Promise(r => paymentsReq.onsuccess = () => r(paymentsReq.result))
                ]).then(([bills, payments]) => {
                    let balance = member.openingBalance || 0;
                    let html = `<h4>Opening Balance: ‚Çπ${balance.toFixed(2)}</h4>`;
                    
                    const all = [...bills.map(b=>({...b,type:'bill'})), ...payments.map(p=>({...p,type:'payment'}))].sort((a,b) => new Date(a.createdDate) - new Date(b.createdDate));
                    
                    all.forEach(item => {
                        if (item.type === 'bill') {
                            balance += item.totalAmount;
                            html += `<div class="ledger-entry"><strong>Bill:</strong> ${item.periodFrom} - Debit: ‚Çπ${item.totalAmount.toFixed(2)} | Balance: ‚Çπ${balance.toFixed(2)}</div>`;
                        } else {
                            balance -= item.amount;
                            html += `<div class="ledger-entry"><strong>Payment:</strong> ${item.date} - Credit: ‚Çπ${item.amount.toFixed(2)} | Balance: ‚Çπ${balance.toFixed(2)}</div>`;
                        }
                    });
                    
                    html += `<h3 style="margin-top:20px;">Current Outstanding: ‚Çπ${balance.toFixed(2)}</h3>`;
                    document.getElementById('memberLedgerContent').innerHTML = html;
                    document.getElementById('memberLedgerModal').classList.add('active');
                });
            };
        }

        function loadEntriesPage() {
            if (!currentSocietyId) return;
            const t = db.transaction(['entries'], 'readonly');
            const r = t.objectStore('entries').index('societyId').getAll(currentSocietyId);
            r.onsuccess = () => {
                const e = r.result;
                document.getElementById('contentArea').innerHTML = `
                    <div style="margin-bottom:20px;"><button class="btn btn-success" onclick="openEntryModal()">+ New Entry</button></div>
                    <table class="data-table"><thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>TDS</th><th>Net</th></tr></thead>
                    <tbody>${e.map(x=>`<tr><td>${x.date}</td><td>${x.entryType}</td><td>‚Çπ${x.amount.toFixed(2)}</td><td>‚Çπ${(x.tdsAmount||0).toFixed(2)}</td><td>‚Çπ${(x.netAmount||x.amount).toFixed(2)}</td></tr>`).join('')||'<tr><td colspan="5" style="text-align:center;">No entries</td></tr>'}</tbody></table>
                `;
            };
        }

        function openEntryModal() {
            document.getElementById('entryDate').value = new Date().toISOString().split('T')[0];
            const t = db.transaction(['accounts'], 'readonly');
            t.objectStore('accounts').index('societyId').getAll(currentSocietyId).onsuccess = (e) => {
                const accounts = e.target.result;
                const debit = document.getElementById('debitAccount');
                const credit = document.getElementById('creditAccount');
                debit.innerHTML = '<option value="">Select</option>';
                credit.innerHTML = '<option value="">Select</option>';
                accounts.forEach(a => {
                    const opt1 = document.createElement('option');
                    opt1.value = a.id;
                    opt1.textContent = `${a.name} (${a.group})`;
                    debit.appendChild(opt1);
                    const opt2 = document.createElement('option');
                    opt2.value = a.id;
                    opt2.textContent = `${a.name} (${a.group})`;
                    credit.appendChild(opt2);
                });
            };
            document.getElementById('entryModal').classList.add('active');
        }

        function calculateTDS() {
            const amt = parseFloat(document.getElementById('entryAmount').value) || 0;
            const tdsPercent = parseFloat(document.getElementById('tdsPercent').value) || 0;
            const tdsAmt = amt * (tdsPercent / 100);
            const netAmt = amt - tdsAmt;
            document.getElementById('tdsAmount').value = tdsAmt.toFixed(2);
            document.getElementById('netAmount').value = netAmt.toFixed(2);
        }

        function saveEntry(e) {
            e.preventDefault();
            const entry = {societyId:currentSocietyId,entryType:document.getElementById('entryType').value,date:document.getElementById('entryDate').value,debitAccountId:parseInt(document.getElementById('debitAccount').value),creditAccountId:parseInt(document.getElementById('creditAccount').value),amount:parseFloat(document.getElementById('entryAmount').value),tdsPercent:parseFloat(document.getElementById('tdsPercent').value)||0,tdsAmount:parseFloat(document.getElementById('tdsAmount').value)||0,netAmount:parseFloat(document.getElementById('netAmount').value),description:document.getElementById('entryDescription').value,createdDate:new Date().toISOString()};
            db.transaction(['entries'],'readwrite').objectStore('entries').add(entry).onsuccess = () => {
                showAlert('Entry saved!','success');
                closeModal('entryModal');
                loadEntriesPage();
            };
        }

        function loadReportsPage() {
            document.getElementById('contentArea').innerHTML = '<h3>Reports</h3><div class="stats-grid"><div class="stat-card" onclick="alert(\'Feature coming soon\')"><h3>üìä</h3><p>Balance Sheet</p></div><div class="stat-card" onclick="alert(\'Feature coming soon\')"><h3>üí∞</h3><p>P&L Statement</p></div></div>';
        }

        function loadBackupPage() {
            document.getElementById('contentArea').innerHTML = '<h3>Backup & Export</h3><div style="margin:20px 0;"><button class="btn btn-success" onclick="alert(\'Feature coming soon\')">Export All Data</button></div>';
        }

        function loadSocietiesIntoDropdown() {
            const t = db.transaction(['societies'], 'readonly');
            t.objectStore('societies').getAll().onsuccess = (e) => {
                const s = e.target.result;
                const sel = document.getElementById('sidebarSocietySelect');
                sel.innerHTML = '<option value="">Select Society</option>';
                s.forEach(soc => {
                    const opt = document.createElement('option');
                    opt.value = soc.id;
                    opt.textContent = soc.name;
                    sel.appendChild(opt);
                });
                if (currentSocietyId) sel.value = currentSocietyId;
            };
        }

        function changeSociety() {
            const sel = document.getElementById('sidebarSocietySelect');
            currentSocietyId = sel.value ? parseInt(sel.value) : null;
            if (currentSocietyId) {
                localStorage.setItem('selectedSocietyId', currentSocietyId);
                const t = db.transaction(['societies'], 'readonly');
                t.objectStore('societies').get(currentSocietyId).onsuccess = (e) => {
                    document.getElementById('currentSocietyName').textContent = e.target.result.name;
                    loadDashboard();
                };
            }
        }

        function selectSocietyDirect(id) {
            currentSocietyId = id;
            localStorage.setItem('selectedSocietyId', id);
            document.getElementById('sidebarSocietySelect').value = id;
            const t = db.transaction(['societies'], 'readonly');
            t.objectStore('societies').get(id).onsuccess = (e) => {
                document.getElementById('currentSocietyName').textContent = e.target.result.name;
                navigateTo('dashboard');
            };
        }

        function checkSelectedSociety() {
            const saved = localStorage.getItem('selectedSocietyId');
            if (saved) {
                currentSocietyId = parseInt(saved);
                document.getElementById('sidebarSocietySelect').value = currentSocietyId;
                const t = db.transaction(['societies'], 'readonly');
                t.objectStore('societies').get(currentSocietyId).onsuccess = (e) => {
                    if (e.target.result) document.getElementById('currentSocietyName').textContent = e.target.result.name;
                };
            }
            loadDashboard();
        }

        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function showAlert(msg, type) {
            const box = document.getElementById('alertBox');
            box.className = `alert alert-${type} show`;
            box.textContent = msg;
            setTimeout(() => box.classList.remove('show'), 5000);
        }

        window.onload = () => initDB();
    </script>
</body>
</html>
